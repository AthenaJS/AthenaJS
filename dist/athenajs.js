!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.AthenaJS=t():e.AthenaJS=t()}(this,function(){return function(e){function t(n){if(i[n])return i[n].exports;var s=i[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,t),s.l=!0,s.exports}var i={};return t.m=e,t.c=i,t.i=function(e){return e},t.d=function(e,i,n){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=45)}([function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(22),o=i.n(s),r=function e(){var t=this;n(this,e),this.promise=new o.a(function(e,i){t.resolve=e,t.reject=i})};t.a=r},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(26),o=i(28),r=i(25),a=i(27),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l={},h={},c=function(){function e(){n(this,e),this.addEasing("linear",function(e){return e})}return u(e,[{key:"addFX",value:function(e,t){l[e]=t}},{key:"getEffect",value:function(e){return l[e]}},{key:"addEasing",value:function(e,t){h[e]=t}},{key:"getEasing",value:function(e){return h[e]}}]),e}(),f=new c;f.addFX("Mosaic",a.a),f.addFX("Fade",s.a),f.addFX("Rotate",o.a),f.addFX("Custom",r.a),t.a=f},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=function(){function e(t){n(this,e),this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.width=t.width||0,this.height=t.height||0,this.inertia=t.inertia||1,this.upCollide=t.upCollide||!0,this.downCollide=t.downCollide||!0}return s(e,null,[{key:"TYPE",get:function(){return{AIR:1,WALL:2,LADDER:3}}}]),e}();t.a=o},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=function(){function e(t,i,s){n(this,e),this.sprite=t,this.Input=i,t.gravity=void 0!==s.gravity?s.gravity:0,t.vx=void 0!==s.vx?s.vx:0,t.vy=void 0!==s.vy?s.vy:0,this.checkWalls=s.checkWalls||!1,this.checkFall=s.checkFall||!1,this.onVXChange=s.onVXChange||null,this.onVYChange=s.onVYChange||null}return s(e,[{key:"onMove",value:function(e){}},{key:"getMapEvent",value:function(){return this.sprite.currentMap.mapEvent}}]),e}();t.a=o},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(1),o=i(29),r=i(9),a=i(5),u=i(0),l=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),h=function(){function e(t,i){if(n(this,e),this.type=t,this.id=i.objectId||this.type+(new Date).getTime(),this.currentMap=null,this.currentScene=null,this._destroyed=!1,this.children=[],this.wave=i.wave||null,this.behavior=null,this.platform=null,this.collideGroup=i.collideGroup||0,this.canCollideFriendBullet=i.canCollideFriendBullet||!1,this.master=i.master||!1,i.behavior&&(console.log("need to set move to",i.behavior),this.setBehavior(i.behavior,i.behaviorOptions)),this._settings=Object.assign({speed:1,visible:!0,canCollide:!1,plane:0,x:0,y:0,vx:0,vy:0,scale:1,angle:0,moving:!0,gravity:0,data:{},path:null,target:null,targetOffsetX:0,targetOffsetY:0,wave:i.wave||null},i),this.target=null,this.spline=null,this.currentMovement="",this.fxQueue={},i.pool||(this.reset(),i.animate&&this.animate(i.animate.name,i.animate.options)),i.scene)return void i.scene.addObject(this);i.map}return l(e,[{key:"reset",value:function(){this.speed=this._settings.speed,this.visible=this._settings.visible,this.canCollide=this._settings.canCollide,this.plane=this._settings.plane,this.x=this._settings.x,this.y=this._settings.y,this.scale=this._settings.scale,this.angle=this._settings.angle,this.moving=this._settings.moving,this.data=this._settings.data,this.path=null,this.vx=this._settings.vx||0,this.vy=this._settings.vy||0,this.gravity=this._settings.gravity,this.moveHandlers=[],this.targetOffsetX=this._settings.targetOffsetX||0,this.targetOffsetY=this._settings.targetOffsetY||0,this.target=this._settings.target||null,this.savedX=this.x,this.savedY=this.y,this.wave=this._settings.wave}},{key:"setMap",value:function(e){this.currentMap=e,this.children.forEach(function(t){t.setMap(e)})}},{key:"setScene",value:function(e){this.currentScene=e,this.children.forEach(function(t){t.setScene(e)})}},{key:"setPlatform",value:function(e){this.platform=e}},{key:"moveTo",value:function(e,t){return this.x=e,this.y=t,this._onMove(),this}},{key:"center",value:function(){var e=this.currentScene.display;return this.x=(e.width-this.w)/2,this.y=(e.height-this.h)/2,this}},{key:"setBehavior",value:function(e,t){this.behavior=new(o.a.getBehavior(e))(this,r.a,t)}},{key:"clearBehavior",value:function(){this.vx=this.vy=0,this.behavior=null}},{key:"move",value:function(){this.moving&&(this.behavior?this.behavior.onMove():(this.x+=this.vx,this.y+=this.vy,this.vy-=this.gravity),this.children.length&&this.children.forEach(function(e){e.move()}))}},{key:"savePosition",value:function(){this.savedX=this.x,this.savedY=this.y}},{key:"getSavedPosition",value:function(){return{x:this.savedX,y:this.savedY}}},{key:"moveWithSpline",value:function(){}},{key:"setPath",value:function(e){this.path=e}},{key:"setScale",value:function(e){this.scale=e}},{key:"setAngle",value:function(e){this.angle=e}},{key:"getAngle",value:function(){return this.angle}},{key:"transform",value:function(e,t){switch(e){case"scale":this.scale=t}}},{key:"hide",value:function(){return this.visible=!1,this}},{key:"show",value:function(){return this.visible=!0,this}},{key:"getCurrentWidth",value:function(){return this.width}},{key:"getCurrentHeight",value:function(){return this.height}},{key:"hitTest",value:function(e){var t=e.getHitBox(),i=!1;if(this.canCollide&&e.canCollide&&this!==e&&this.visible){var n=this.getHitBox(),s={x:this.x+n.x,y:this.y+n.y,x2:this.x+n.x+n.x2,y2:this.y+n.y2+n.y};(s.y<e.y+t.y&&s.y2>e.y+t.y||s.y>e.y+t.y&&s.y<e.y+t.y+t.y2)&&(s.x<e.x+t.x&&s.x2>e.x+t.x||s.x>e.x+t.x&&s.x<e.x+t.x+t.x2)&&(e.onCollision(this),this.onCollision(e),i=!0)}if(!i)for(var o=this.children.length,r=0;!i&&r<o;)i=this.children[r].hitTest(e),r++;return i}},{key:"setTarget",value:function(e){this.target=e}},{key:"addMoveHandler",value:function(e){this.moveHandlers.push(e)}},{key:"onHit",value:function(e){console.log("[GfxObject] oops, ",this.type," [",this.id,"] ","was hit by",e.name," [",e.id,"]")}},{key:"_onMove",value:function(){var e=[this.x,this.y];this.moveHandlers.forEach(function(t){return t.apply(void 0,e)})}},{key:"isFxQueueEmpty",value:function(){for(var e in this.fxQueue)return!1;return!0}},{key:"animate",value:function(e,t){var i=this,n=s.a.getEffect(e),o=(new u.a).resolve(),r=t.easing||"linear",a=void 0;return void 0!==this.fxQueue[e]?console.warn("Fx",e,"already in progress, cannot execute twice"):n?(a=new n(t),a.setEasing(new s.a.getEasing(r)),o=a.start().then(function(){delete i.fxQueue[e]}),this.fxQueue[e]=a):console.warn("Fx",e,"unknown: did you spell it correctly ?"),o}},{key:"stopAnimate",value:function(e){var t=this,i=null;Object.keys(this.fxQueue).forEach(function(n){i=t.fxQueue[n],i.stop(e)})}},{key:"executeFx",value:function(e,t){var i=this,n=null;Object.keys(this.fxQueue).forEach(function(s){n=i.fxQueue[s],n.process(e,null,i,t)})}},{key:"onCollision",value:function(){}},{key:"addChild",value:function(e){e.setMap(this.currentMap),e.setScene(this.currentScene),this.children.push(e)}},{key:"removeChild",value:function(e){var t=this.children.indexOf(e);t>-1&&(this.children[t].destroy(),this.children.splice(t,1))}},{key:"removeAllChildren",value:function(){for(var e=0;e<this.children.length;++e)this.children[e].destroy();this.children.length=0}},{key:"draw",value:function(e,t){console.error("[GfxObject] you need to define a draw method for your object, GfxObjects do not have a draw method")}},{key:"playSound",value:function(e,t){var i=0,n=this.currentMap,s=1,o=t||{pan:!0,loop:!1};(n&&(this.x<-n.viewportX||this.x>-n.viewportX+n.viewportW)||this.y<-n.viewportY||this.y>-n.viewportY+n.viewportH)&&(s=.2),n&&o.pan&&(i=this.x<n.masterObject.x?-5:5),this.sound=a.a.play(e,o.loop||!1,s,i)}},{key:"setImage",value:function(e){}},{key:"showObjectBox",value:function(e){e.strokeStyle="rgb(0,230,0)",e.beginPath(),e.moveTo(this.x,this.y),e.lineTo(this.w+this.x,this.y),e.lineTo(this.w+this.x,this.y+this.h),e.lineTo(this.x,this.y+this.h),e.lineTo(this.x,this.y),e.closePath(),e.stroke()}},{key:"destroy",value:function(){this._destroyed=!0,"function"==typeof this.freeFromPool&&this.freeFromPool(),this.currentMap?this.currentMap.removeObject(this):this.currentScene&&this.currentScene.removeObject(this),this.children.forEach(function(e){e.destroy()})}}]),e}();t.a=h},function(e,t,i){"use strict";t.a={audioCache:{},enabled:!0,addSound:function(e,t){this.audioCache[e]=t},toggleSound:function(e){this.enabled=e},play:function(e,t,i,n){var s=null;if(this.enabled){try{s=this.audioCache[e]}catch(t){return void console.warn("[AM] WARN: unable to play sound",e)}if(void 0!==s)return"function"==typeof s.loop?s.loop(t||!1):s.loop=t||!1,s.play({panning:[n||0,0,5],volume:i||1,loop:t||!1})}},stop:function(e,t){var i=null;if(this.enabled){try{i=this.audioCache[e]}catch(t){return void console.warn("[AM] WARN: unable to stop sound",e)}i&&"function"==typeof i.stop&&i.stop(t||void 0)}}}},function(e,t,i){"use strict";function n(e){return new(e.bind.apply(e,arguments))}var s=i(11),o=i(5),r=i(14),a=i(42),u=i.n(a),l=i(0),h=i(7),c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.a={isLocal:!!document.location.href.match(/^file:\/\//),scriptMaxTime:3e3,groupMaxTime:5e3,resources:{any:{def:new l.a,loadedRes:0,numRes:0,res:{},progressCb:null,errorCb:null}},dynamicScripts:{},iOS:!!navigator.userAgent.match(/iPhone|iPad/),skipResources:["script"],async:!0,loading:!1,getResourceById:function(e,t,i){t=t||"any";var n=this.resources[t].res,s=n[e];return s&&s.loaded?!0===i?s:s.elt:this.dynamicScripts[e]?this.dynamicScripts[e]:void console.error("[RM] unknwon resource id",e)},newResourceFromPool:function(e){var t=this.getResourceById(e);return"function"==typeof t.createFromPool?(console.log("getting resource from pool!"),t.createFromPool.apply(t,Array.prototype.slice.call(arguments,1))):(console.log("no pool for this one: using new instead"),n.apply(void 0,[t].concat(Array.prototype.slice.call(arguments,1))))},_createGroup:function(e){this._groupExists(e)?this.resources[e].def=new l.a:this.resources[e]={def:new l.a,loadedRes:0,numRes:0,res:{},progressCb:null,errorCb:null}},_groupExists:function(e){return void 0!==this.resources[e]},addResources:function(e,t){t=t||"any",this._createGroup(t);var i=void 0,n=this.resources[t];if(null!==e)if("object"===(void 0===e?"undefined":c(e))&&e.constructor===Array)for(i in e)void 0===n.res[e[i].id]&&-1===this.skipResources.indexOf(e[i].type)&&(n.res[e[i].id]=JSON.parse(JSON.stringify(e[i])),n.numRes++);else void 0===n.res[e.id]&&-1===this.skipResources.indexOf(e.type)&&(n.res[e.id]=JSON.parse(JSON.stringify(e)),n.numRes++);return null!==e&&n.numRes!==n.loadedRes||n.def.resolve(!0),n.def.promise},loadNextResource:function(e){var t=this.resources[e],i=void 0;for(i in t.res)if(!t.res[i].loaded&&-1===this.skipResources.indexOf(t.res[i].type)){this._loadResource(t.res[i],e);break}},loadResources:function(e,t,i){var n=this;if(e=e||"any",!0===this.loading)return void console.warn("[ResourceManager] loadResources() -> already loading");this.loading=!0;var s=this.resources[e],o=null,r=void 0,a=0;s.progressCb=t||null,s.errorCb=i||null;for(r in s.res)s.res[r].loaded||-1!==this.skipResources.indexOf(s.res[r].type)||(a++,this.async?this._loadResource(s.res[r],e):null===o&&(o=s.res[r]));if(this.async||this._loadResource(o,e),0===a)return console.warn("[ResourceManager] no ressource to load"),void(this.loading=!1);s.gpTimeout=setTimeout(function(){var e,t=[];if(s.gpTimeout&&"rejected"===s.def.state()){s.gpTimeout=null,console.error("[RM] Unable to load the following resources after",n.groupMaxTime/1e3,"sec");for(e in s.res)s.res[e].loaded||(t.push("["+s.res[e].type+"] "+e),console.warn("["+s.res[e].type+"] "+e+": "+s.res[e].src));s.errorCb&&s.errorCb("Unable to get all resources after",n.groupMaxTime,t)}},this.groupMaxTime)},getCanvasFromImage:function(e){var t=document.createElement("canvas");return t.width=e.naturalWidth,t.height=e.naturalHeight,t.getContext("2d").drawImage(e,0,0),t},loadImage:function(e,t){var i=new Image,n=this,s=new l.a;n.resources[t];return i.onload=function(){e.elt=i,e.img=this,e.loaded=!0,n._resLoaded(t),s.resolve(!0)},i.src=e.src,s.promise},createObjectPool:function(e,t){r.a.create(e,t)},registerScript:function(e,t,i){var n=this.dynamicScripts[e];i&&this.createObjectPool(t,i),n?console.error("existing script with the id",e,"should I replace it?"):this.dynamicScripts[e]=t},loadScript:function(e,t,i){var n=new l.a;this.resources[t];return console.error("loadScript not supported"),console.log("[RM] loading script",e.src),n.promise},loadAudio:function(e,t){function i(){this.removeEventListener("canplaythrough",i),console.log("[RM] audioLoaded",e.src),e.elt=this,e.loaded=!0,o.a.addSound(e.id,this),n._resLoaded(t),r.resolve(!0)}console.log("[RM] loading sound",e.src);var n=this,s=new Audio,r=new l.a;n.resources[t];return s.preload="auto",s.addEventListener("canplaythrough",i),s.addEventListener("loadstart",function(){console.log("loadStarted",s.src)}),s.src=e.src,r.promise},loadWadAudio:function(e,t){var i=this,n=(i.resources[t],new l.a),s=new u.a({source:e.src,callback:function(){e.elt=s,e.loaded=!0,o.a.addSound(e.id,s),i._resLoaded(t),n.resolve(!0)}});return n.promise},loadHowlerAudio:function(e,t){var i=this,n=(i.resources[t],new l.a),s=new Howl.Howl({urls:[e.src],onload:function(){e.elt=s,e.loaded=!0,o.a.addSound(e.id,s),i._resLoaded(t),n.resolve(!0)}});return n.promise},loadJSON:function(e,t,i){var n=this,s=new l.a;fetch(e.src).then(function(e){if(200===e.status)return e.json();throw"Error getting photo list"}).then(function(o){if(e.elt=o,e.loaded=!0,i){i.call(n,e,t).then(function(){s.resolve(!0)})}else n._resLoaded(t),loaded.resolve(!0)})},loadMapData:function(e,t){var i=this,n=new l.a,o=this.resources[t];return s.a.getArrayBuffer((document.location.href.match("warpdesign.fr")?"/gods/":"")+e.elt.dataUrl).then(function(s){e.elt.buffer=s,e.loaded=!0,i._resLoaded(t),n.resolve(!0)},function(){o.def.reject('Unable to load map resource "'+e.src+'" ['+e.id+"]")}),n.promise},_resLoaded:function(e){var t=this.resources[e];t.loadedRes++,new h.a("span.loaded").html(t.loadedRes),t.progressCb&&t.progressCb.call(this,Math.floor(100*t.loadedRes/t.numRes)),t.loadedRes===t.numRes?(this.loading=!1,null!==t.gpTimeout&&clearTimeout(t.gpTimeout),t.def.resolve(!0)):this.async||this.loadNextResource(e)},_loadResource:function(e,t){switch(e.type){case"image":return this.loadImage(e,t);case"audio":return this.loadWadAudio(e,t);case"script":return this.loadScript(e,t);default:return this.loadJSON(e,t,this.loadMapData)}}}},function(e,t,i){"use strict";function n(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function s(e){e.match(/^#|\./)?this.push.apply(this,n(document.querySelectorAll(e))):this.push(document.createElement(e))}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};s.prototype=new Array,Object.assign(s.prototype,{css:function(e,t){return"object"===(void 0===e?"undefined":o(e))?this.forEach(function(t){var i=t.style;for(var n in e)i[n]=e[n]}):this.forEach(function(i){i.style[e]=t}),this},appendTo:function(e){var t="object"===(void 0===e?"undefined":o(e))&&e||document.querySelector(e);return t&&this.forEach(function(e){t.appendChild(e)}),this},attr:function(e,t){return"object"===(void 0===e?"undefined":o(e))?this.forEach(function(t){for(var i in e)t.setAttribute(i,e[i])}):this.forEach(function(i){i.setAttribute(e,t)}),this},addClass:function(e){return this.forEach(function(t){t.classList.add(e)}),this},html:function(e){return this.forEach(function(t){return t.innerHTML=e}),this},show:function(){this.forEach(function(e){e.style.display="block"})},hide:function(){this.forEach(function(e){e.style.display="node"})}}),t.a=s},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(0),o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=function(){function e(t,i){n(this,e),this.easing=null,this.context=t.context||this,void 0!==i&&(this.width=i.width,this.height=i.height),this.startValue=void 0!==t.startValue?t.startValue:0,this.endValue=void 0!==t.endValue?t.endValue:1,this.loop=!!t.loop||!1,this.duration=t.duration||400}return o(e,[{key:"setEasing",value:function(e){this.easing=e}},{key:"start",value:function(){return this.def=new s.a,this.startTime=(new Date).getTime(),this.ended=!1,this.stopped=!1,this.def.promise}},{key:"stop",value:function(e){this.stopped=!0}},{key:"process",value:function(e,t,i){var n=this,s=(new Date).getTime(),o=s-this.startTime,r=o/this.duration;return this.stopped||o>=this.duration?this.stopped||!1===this.loop?(this.animProgress=1,this.ended=!0,setTimeout(function(){n.def.resolve(!0)},0)):this.start():this.animProgress=this.easing(r,o,0,1,this.duration),this.ended}}]),e}();t.a=r},function(e,t,i){"use strict";t.a={keys:{UP:38,DOWN:40,LEFT:37,RIGHT:39,SPACE:32,ENTER:13,ESCAPE:27,CTRL:17},PAD_BUTTONS:{32:1,FACE_0:1,FACE_3:2,FACE_4:3,LEFT_SHOULDER:4,RIGHT_SHOULDER:5,LEFT_SHOULDER_BOTTOM:6,RIGHT_SHOULDER_BOTTOM:7,SELECT:8,START:9,LEFT_ANALOGUE_STICK:10,RIGHT_ANALOGUE_STICK:11,38:12,40:13,37:14,39:15},axes:{},gamepadSupport:!1,recording:!1,playingEvents:!1,playingPos:0,recordedEvents:[],pad:null,keyPressed:{},padPressed:{},keyCb:{},gameRef:null,inputMode:"keyboard",dPadJoystick:null,jPollInterval:0,_init:function(e){this.gameRef=e,this._installInputModeSwitchHandler(),this._installKBEventHandlers(),this.setInputMode(this.inputMode)},_installInputModeSwitchHandler:function(){var e=this;document.addEventListener("touchstart",function(){e.setInputMode("joystick")}),document.addEventListener("keydown",function(){e.setInputMode("keyboard")})},startRecordingEvents:function(){this.recording||(this.recordedEvents.length=0,this.recording=!0,console.log("[InputManager] Starting record of input events!"))},stopRecordingEvents:function(){this.recording=!1,console.log("[InputManager] Stoping record of input events, recorded",this.recordedEvents.length,"events")},playRecordedEvents:function(){this.playingEvents||(console.log("[InputManager] Starting to play an existing record of input events!"),this.playingEvents=!0,this.playPos=0)},nextRecordedEvents:function(){this.playingPos>=this.recordedEvents.length?(this.playingEvents=!1,this.keyPressed={38:!1,40:!1,37:!1,39:!1,32:!1,13:!1,27:!1,17:!1},console.log("[InputManager] Reached the end of recorded events, resetting keys status to default!")):this.keyPressed=this.recordedEvents[this.playingPos++]},recordEvents:function(){this.recordedEvents.push(JSON.parse(JSON.stringify(this.keyPressed)))},setInputMode:function(e){if(this.inputMode!==e){switch(e){case"virtual_joystick":this.dPadJoystick&&(this.jPollInterval=setInterval(this._pollJoystick.bind(this),1/30*1e3));break;case"keyboard":this._clearJoystickPoll();break;case"gamepad":this._clearJoystickPoll(),this.jPollInterval=setInterval(this._pollGamepad.bind(this),1/30*1e3)}this._resetKeys(),this.inputMode=e}},_resetKeys:function(){for(var e in this.keyPressed)this.keyPressed[e]=!1},_pollNewGamepad:function(){var e=navigator.getGamepads&&navigator.getGamepads()||navigator.webkitGetGamepads&&navigator.webkitGetGamepads()||navigator.webkitGamepads;!this.pad&&e&&null!==e.item()&&(this.pad=e.item(),this.gamepadSupport||(console.log("[Event] Oh oh! Looks like we have a new challenger: ",this.pad.id),this.gamepadSupport=!0,this.setInputMode("gamepad")))},_pollGamepad:function(e){this.pad.buttons[12].pressed?(this.keyPressed[this.keys.UP]=!0,this.keyPressed[this.keys.DOWN]=!1):this.pad.buttons[13].pressed?(this.keyPressed[this.keys.DOWN]=!0,this.keyPressed[this.keys.UP]=!1):(this.keyPressed[this.keys.DOWN]=!1,this.keyPressed[this.keys.UP]=!1),this.pad.buttons[15].pressed?(this.keyPressed[this.keys.RIGHT]=!0,this.keyPressed[this.keys.LEFT]=!1):this.pad.buttons[14].pressed?(this.keyPressed[this.keys.LEFT]=!0,this.keyPressed[this.keys.RIGHT]=!1):(this.keyPressed[this.keys.LEFT]=!1,this.keyPressed[this.keys.RIGHT]=!1)},_getModifiers:function(e){return{ALT:!0,SHIFT:!0,CTRL:!0,META:!0}},_initVirtualJoystick:function(){var e=this,t=void 0,i=void 0;console.log("[InputManager] _initVirtualJoystick"),t=this.dPadJoystick=new VirtualJoystick({container:document.body,strokeStyle:"cyan",limitStickTravel:!0,mouseSupport:!0,stickRadius:60}),t.addEventListener("touchStartValidation",function(e){return!(e.changedTouches[0].pageX>=window.innerWidth/2)}),i=this.fireJoystick=new VirtualJoystick({container:document.body,strokeStyle:"orange",limitStickTravel:!0,mouseSupport:!0,stickRadius:0}),i.addEventListener("touchStartValidation",function(e){return!(e.changedTouches[0].pageX<window.innerWidth/2)}),i.addEventListener("touchStart",function(){"virtual_joystick"===e.inputMode&&(e.keyPressed[e.keys.CTRL]=!0)}),i.addEventListener("touchEnd",function(){"virtual_joystick"===e.inputMode&&(e.keyPressed[e.keys.CTRL]=!1)})},_clearJoystickPoll:function(){this.jPollInterval&&(clearInterval(this.jPollInterval),this.jPollInterval=0)},_pollJoystick:function(){var e=this,t=[],i=[],n=this.dPadJoystick;this.fireJoystick;Math.abs(n.deltaX())>=10?n.left()?(t.push("LEFT"),i.push("RIGHT")):(t.push("RIGHT"),i.push("LEFT")):(i.push("LEFT"),i.push("RIGHT")),Math.abs(n.deltaY())>=10?n.up()?(t.push("UP"),i.push("DOWN")):(t.push("DOWN"),i.push("UP")):(i.push("UP"),i.push("DOWN")),t.length&&t.forEach(function(t){e.keyPressed[e.keys[t]]=!0}),i.length&&i.forEach(function(t){e.keyPressed[e.keys[t]]=!1})},_installKBEventHandlers:function(){var e=this,t=this.gameRef;document.addEventListener("keydown",function(i){if("keyboard"===e.inputMode&&!e.playingEvents){switch(i.keyCode){case 32:case 37:case 38:case 39:case 40:i.preventDefault()}i.keyCode&&(e.keyPressed[i.keyCode]=!0),e.metas=e._getModifiers(),e.keyCb[i.keyCode]&&t&&t.running&&e.keyCb[i.keyCode].down.forEach(function(e){e()})}}),document.addEventListener("keyup",function(i){"keyboard"!==e.inputMode||e.playingEvents||(i.keyCode&&(e.keyPressed[i.keyCode]=!1),e.metas=e._getModifiers(),e.keyCb[i.keyCode]&&t&&t.running&&e.keyCb[i.keyCode].up.forEach(function(e){e()}))})},getAllKeysStatus:function(){for(var e=Object.keys(this.keys),t={},i=0;i<e.length;++i)t[array[i]]=this.getKeyStatus(array[i]);return t},getKeyStatus:function(e,t){var i=void 0;try{return i=this.keyPressed[e]||this.padPressed[e],i&&!0===t&&(this.keyPressed[e]=""),i}catch(e){return!1}},installKeyCallback:function(e,t,i){var n=this.keys[e];this.keyCb[n]||(this.keyCb[n]={up:[],down:[]}),this.keyCb[n][t].push(i)},removeKeyCallback:function(e,t,i){var n=this.keyCb[e][t].indexOf(i);n>-1&&this.keyCb[e][t].splice(n,1)},clearEvents:function(){this.keyPressed={},this.keyCb={}}}},function(e,t,i){"use strict";var n={};t.a={notify:function(e,t){var i={type:e,data:t};n[e]?n[e].forEach(function(e){return e(i)}):n["*"]&&n["*"].forEach(function(e){return e(i)})},listen:function(e,t){console.log("[NM] listening to event",e),e.replace(/\s+/g," ").split(" ").forEach(function(e){n[e]||(n[e]=[]),n[e].push(t)})}}},function(e,t,i){"use strict";var n=i(22),s=i.n(n);t.a={sendArrayBufferView:function(e,t){var i=new XMLHttpRequest;i.open("POST",t,!0),i.send(e)},getArrayBuffer:function(e){return new s.a(function(t,i){var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(e){var s=n.response;s?t(s):i(!1)},n.send(null)})}}},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(4),a=(i(9),i(0)),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(n)},h=function(e){function t(e,i){n(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e||"Sprite",i||{}));return o.imageSrc=i&&i.imageSrc||"",i&&i.animations&&o.load(i.animations),o}return o(t,e),u(t,[{key:"initProperties",value:function(){this.animations={},this.currentAnim=null,this.currentFrame=null,this.currentFrameNum=this.previousFrameNum=0,this.loaded=!1,this.currentAnimName="",this.storedAnimName="",this.storedFrameNum=0,this.numFrames=0,this.rewindOnEnd=!1,this.direction=1,this.frameCounter=0,this.animEndDef=null,this.animChangeDef=null,this.rewinded=!1,this.isDebug=!1}},{key:"debug",value:function(e){this.isDebug=e}},{key:"reset",value:function(){l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this)}},{key:"addAnimation",value:function(e,t){var i=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},s={},o=new a.a,r=new Image;return s[e]=Object.assign({frameDuration:1,loop:1,frames:[]},n),this.imageSrc=r.src=t,this.setImage(r),r.onload=function(){for(var t=n.offsetX||0,i=n.offsetY||0,r=s[e].frames,a=n.frameHeight||this.naturalHeight,u=n.frameWidth+(n.frameSpacing||0);t<this.naturalWidth;)r.push({offsetX:t,offsetY:i,w:n.frameWidth,h:a,hitBox:{x:0,y:0,x2:n.frameWidth-1,y2:a-1}}),t+=u;o.resolve()}.bind(r),o.promise.then(function(){i.load(s)}),o.promise}},{key:"load",value:function(e){var t=this;this._settings;var i=e||this._settings.animations,n=void 0;this.loaded||(this.initProperties(),this.loaded=!0,Object.keys(i).forEach(function(e){var s=i[e];t.animations[e]=s,n=e,s.flipFrom&&t.updateFlipAnimation(s,s.flipFrom,s.flipType)}),this.setAnimation(n))}},{key:"updateFlipAnimation",value:function(e,t,i){var n=this.animations[t].frames;e.frames=new Array(n.length);for(var s=0;s<n.length;++s)e.frames[s]={},Object.assign(e.frames[s],n[s]),1&i&&(e.frames[s].hitBox.x=n[s].w-n[s].hitBox.x2,e.frames[s].hitBox.x2=n[s].w-n[s].hitBox.x),2&i&&(e.frames[s].hitBox.y=n[s].h-n[s].hitBox.y2,e.frames[s].hitBox.y2=n[s].h-n[s].hitBox.y)}},{key:"setImage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.image&&!t||(this.image=e,this.children.forEach(function(t){t.setImage(e)}))}},{key:"rewind",value:function(){this.direction=-this.direction,this.running=!0,this.rewinded=!0,this.nextFrame(),console.log("[Sprite] rewind",this.currentFrameNum,this.running,this.rewinded,this.direction)}},{key:"nextFrame",value:function(){if(this.running)if(this.currentFrameNum+=this.direction,this.currentFrameNum<0||this.currentFrameNum>=this.numFrames)switch(this.currentAnim.loop){case 2:this.direction=-this.direction,this.currentFrameNum=this.currentFrameNum<0?0:this.numFrames-1,this.currentFrame=this.currentAnim.frames[this.currentFrameNum];break;case 1:this.currentFrameNum=this.currentAnim.loopFrom?this.currentAnim.loopFrom:0,this.currentFrame=this.currentAnim.frames[this.currentFrameNum];break;default:!this.currentAnim.rewindOnEnd||this.rewinded?(this.currentFrameNum-=this.direction,this.running=!1,this._animationEnded()):this.currentAnim.rewindOnEnd&&this.rewind()}else this.currentFrame=this.currentAnim.frames[this.currentFrameNum]}},{key:"storeCurrentAnim",value:function(){this.storedAnimName=this.currentAnimName,this.storedFrameNum=this.currentFrameNum}},{key:"restorePreviousAnim",value:function(){this.setAnimation(this.storedAnimName,null,this.storedFrameNum)}},{key:"advanceFrame",value:function(e){this.previousFrameNum=this.currentFrameNum,this.currentAnim!==this.animations[e]?(this.frameCounter=0,this.setAnimation(e)):++this.frameCounter>this.currentAnim.frameDuration&&(this.nextFrame(),this.frameCounter=0)}},{key:"getCurrentWidth",value:function(){return this.currentFrame.w}},{key:"getCurrentHeight",value:function(){return this.currentFrame.h}},{key:"getCurrentOffsetX",value:function(){return this.currentFrame.offsetX}},{key:"getCurrentOffsetY",value:function(){return this.currentFrame.offsetY}},{key:"getCurrentShiftX",value:function(){return this.currentFrame.shiftX||0}},{key:"getCurrentShiftY",value:function(){return this.currentFrame.shiftY||0}},{key:"getHitBox",value:function(){return this.currentFrame.hitBox}},{key:"centerXOverTile",value:function(e){var t=this.currentMap.tileWidth,i=this.getCurrentWidth(),n=Math.floor((t-i)/2);i<=t&&(this.x=e.x*t+n)}},{key:"clearMove",value:function(){this.running=!1}},{key:"setAnimation",value:function(e,t,i,n){this.loaded||this.load();try{this.currentAnim&&this._animationEnded(),this.animEndDef=new a.a,this.currentAnim&&this._animationChanged(this.currentAnimName,e),this.animChangeDef=new a.a,this.currentAnim=this.animations[e],this.currentAnimName=e,this.numFrames=this.currentAnim.frames.length,this.currentFrameNum=this.previousFrameNum=n?this.numFrames-1:i||0,this.currentFrame=this.currentAnim.frames[this.currentFrameNum],this.running=!0,this.rewinded=!1,this.direction=n?-1:1,"function"==typeof t&&this.onAnimationEnd(t)}catch(t){console.error("[Sprite] setAnimation() - unable to set animation ",e,"("+t.message+")","for sprite",this.id)}}},{key:"stopAnimation",value:function(e){this.running=!1,this.animEndDef&&!e&&this.animEndDef.reject()}},{key:"startAnimation",value:function(){this.running=!0}},{key:"onAnimationEnd",value:function(e){this.animEndDef.promise.then(e.bind(this))}},{key:"onAnimationChange",value:function(e){this.animChangeDef.promise.then(e.bind(this))}},{key:"_animationEnded",value:function(){this.animEndDef.resolve(this.currentAnimName,this.currentFrameNum)}},{key:"_animationChanged",value:function(e){this.animChangeDef.resolve(e,this.currentAnimName)}},{key:"onHit",value:function(e){l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"onHit",this).call(this,e),console.log("[Sprite] oops, ",this.type," [",this.id,"] ","was hit by",e.name," [",e.id,"]")}},{key:"draw",value:function(e,t){if(this.visible){this.currentAnimName.length&&this.advanceFrame(this.currentAnimName);var i=this.getCurrentWidth(),n=i*this.scale,s=this.getCurrentHeight(),o=s*this.scale,r=n/2|0,a=o/2|0,u=this.getCurrentOffsetX(),l=this.getCurrentOffsetY(),h=this.currentAnim.flipFrom?this.x+this.getCurrentShiftX()-n:this.x+this.getCurrentShiftX(),c=this.currentAnim.flipFrom?this.y+this.getCurrentShiftY()-o:this.y+this.getCurrentShiftY(),f=this.currentMap&&this.currentMap.viewportX||0,p=this.currentMap&&this.currentMap.viewportY||0;if(i&&s){if(this.isFxQueueEmpty()){this.currentAnim.flipFrom&&(e.save(),e.scale(1&this.currentAnim.flipType?-1:1,2&this.currentAnim.flipType?-1:1));try{e.drawImage(this.image,Math.floor(u),Math.floor(l),Math.floor(i),Math.floor(s),Math.floor(h+f),Math.floor(c+p),Math.floor(n),Math.floor(o))}catch(e){}this.currentAnim.flipFrom&&e.restore(),!0!==this.isDebug&&!0!==t||this.showHitBox(e)}else this.executeFx(e),e.save(),this.currentAnim.flipFrom&&e.scale(1&this.currentAnim.flipType?-1:1,2&this.currentAnim.flipType?-1:1),e.translate(h+f+r,c+p+a),e.rotate(this.angle),e.drawImage(this.image,u,l,i,s,-r,-a,n,o),e.restore(),!0!==this.isDebug&&!0!==t||this.showHitBox(e);this.children.length&&this.children.forEach(function(i){i.draw(e,t)})}}}},{key:"showHitBox",value:function(e){var t=this.getHitBox(),i=this.currentMap&&this.currentMap.viewportX||0,n=this.currentMap&&this.currentMap.viewportY||0;t&&(e.strokeStyle="rgb(0,230,0)",e.beginPath(),e.moveTo(t.x+this.x+i,t.y+this.y+n),e.lineTo(t.x2+this.x+i,t.y+this.y+n),e.lineTo(t.x2+this.x+i,t.y2+this.y+n),e.lineTo(t.x+this.x+i,t.y2+this.y+n),e.lineTo(t.x+this.x+i,t.y+this.y+n),e.closePath(),e.stroke())}},{key:"describeAllAnimations",value:function(){var e=this,t=null,i=this,n=1,s=1,o=0,r=0,a=0,u=0,l=void 0,h=null;Object.keys(this.animations).forEach(function(i){t=e.animations[i],o=t.frames[0].w,r=t.frames[0].h,(o+5)*t.frames.length>a&&(a=(o+5)*t.frames.length),u+=r+5}),l=document.getElementById("describe"),l||(l=document.createElement("canvas"),l.id="describe",l.setAttribute("width",a),l.setAttribute("height",u)),h=new Dom("#describe")[0]&&new Dom("#describe")[0].getContext("2d")||new Dom("canvas").attr("id","describe").attr("width",a).attr("height",u).css("zIndex","100").appendTo("body")[0].getContext("2d"),h.webkitImageSmoothingEnabled=!1,Object.keys(this.animations).forEach(function(a){n=1,t=e.animations[a],console.log(a,"got",t.frames.length),console.log("frameDuration=",t.frameDuration),console.log("loop=",t.loop),console.log("loopFrom=",t.loopFrom),console.log("rewindOnEnd",t.rewindOnEnd),t.frames.forEach(function(e,t){var r=e.w,a=e.h,u=e.offsetX,l=e.offsetY,c=e.hitBox;h.drawImage(i.image,u,l,r,a,n,s,r,a),h.strokeStyle="rgb(240,240,240)",h.beginPath(),h.moveTo(n-1,s-1),h.lineTo(n+r,s-1),h.lineTo(n+r,s+a+1),h.lineTo(n-1,s+a+1),h.lineTo(n-1,s-1),h.closePath(),h.lineCap="butt",h.stroke(),c&&(h.strokeStyle="rgb(0,230,0)",h.beginPath(),h.moveTo(n+c.x,s+c.y),h.lineTo(n+c.x2,s+c.y),h.lineTo(n+c.x2,s+c.y2),h.lineTo(n+c.x,s+c.y2),h.lineTo(n+c.x,s+c.y),h.closePath(),h.stroke()),n+=o+5}),s+=r+5})}},{key:"listAnimations",value:function(){return this.animations}}]),t}(r.a);t.a=h},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(4),a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(n)},l=function(e){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Text"+(new Date).getTime(),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return o.fontFace=i.fontFace||"Arial",o.fontStyle=i.fontStyle||"normal",o.fontSize=i.fontSize||"18px",o.fontWeight=i.fontWeight||"normal",o.align=i.align||"center",o.color=i.color||"white",o._setFont(),i.text&&o.setText(i.text),o.w=i.w||0,o.h=i.h||0,o}return o(t,e),a(t,[{key:"moveWithSpline",value:function(){}},{key:"setSize",value:function(e,t){null!==e&&(this.w=e),null!==t&&(this.h=t)}},{key:"setText",value:function(e,t){this.text=e,this.align=t||"center"}},{key:"setColor",value:function(e){this.color=e}},{key:"getHitBox",value:function(){return{x:0,y:0,x2:this.w,y2:this.y}}},{key:"getCurrentWidth",value:function(){return this.w}},{key:"getCurrentHeight",value:function(){return this.h}},{key:"getCurrentOffsetX",value:function(){return this.offsetX}},{key:"getCurrentOffsetY",value:function(){return this.offsetY}},{key:"onHit",value:function(e){u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"onHit",this).call(this,e),console.log("oops, ",this.type," [",this.id,"] ","was hit by",e.name," [",e.id,"]")}},{key:"draw",value:function(e){this.visible&&(e.fillStyle=this.color,e.font=this.font,e.textBaseline="top",0!==this.angle&&(e.save(),e.rotate(this.angle)),e.fillText(this.text,this.x,this.y),0!==this.angle&&e.restore())}},{key:"_setFont",value:function(){this.font=this.fontSize+" "+this.fontFace}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";t.a={create:function(e,t){e._pool=[],e._poolMarker=0,e._poolSize=0;var i=e._pool;e.createFromPool=function(){e._poolSize<=e._poolMarker&&e.expandPool(10);var t=e._pool[e._poolMarker++];return t._poolIndex=e._poolMarker-1,e.prototype.constructor.apply(t,arguments),t},e.expandPool=function(t){for(var n={pool:!0},s=i.length,o=i.length+t;s<o;s++)i.push(new e(n));e._poolSize+=t},e.prototype.freeFromPool=function(){e._poolMarker>0&&e._poolMarker--;var t=i[e._poolMarker],n=t._poolIndex;i[e._poolMarker]=this,i[this._poolIndex]=t,t._poolIndex=this._poolIndex,this._poolIndex=n},e.expandPool(t)}}},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(1),o=(i(17),i(0)),r=i(7),a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function(){function e(t,i){n(this,e),console.log("[Display] Init()",t.name);var s=function(){var e=window.getComputedStyle(document.documentElement,""),t=(Array.prototype.slice.call(e).join("").match(/-(moz|webkit|ms)-/)||""===e.OLink&&["","o"])[1];return{dom:"WebKit|Moz|MS|O".match(new RegExp("("+t+")","i"))[1],lowercase:t,css:"-"+t+"-",js:t[0].toUpperCase()+t.substr(1)}}();this.layers=new Array(t.numLayers),this.prefix=s.lowercase,this.target=i||new r.a("div").attr("id","display_"+t.name).appendTo("body"),this.width=t.width,this.height=t.height,this.type=t.type||"2d",this.fxCtx=null,this._createLayers(),this.fxQueue={pre:{},post:{}}}return a(e,[{key:"getBuffer",value:function(e,t){var i=new r.a("canvas").attr({width:e+"px",height:t+"px"})[0].getContext("2d");return i.imageSmoothingEnabled=!1,i}},{key:"_createLayers",value:function(){var e=void 0;for(e=0;e<this.layers.length;++e)this.layers[e]=new r.a("canvas").addClass("layer_"+e).attr({width:this.width,height:this.height}).css({width:this.width+"px",height:this.height+"px",zIndex:e}).appendTo(this.target)[0].getContext(this.type),this.layers[e].imageSmoothingEnabled=!1;this.fxCtx=new r.a("canvas").addClass("fx").attr({width:this.width,height:this.height}).css({width:this.width+"px",height:this.height+"px",zIndex:e+1}).appendTo(this.target)[0].getContext(this.type),this.fxCtx.imageSmoothingEnabled=!1}},{key:"clearScreen",value:function(e){e.clearRect(0,0,e.canvas.width,e.canvas.height)}},{key:"clearAllScreens",value:function(){for(var e=0;e<this.layers.length;++e)this.clearScreen(this.layers[e]);this.clearScreen(this.fxCtx)}},{key:"renderScene",value:function(e){this.clearScreen(this.fxCtx),this.executeFx(this.layers[0],null,e,null,"pre");for(var t=0;t<this.layers.length;++t)this.layers[t].canvas.style.opacity=e.getOpacity();if(this.clearScreen(this.layers[1]),e.render(this.layers),e.hudScene&&e.hudScene.render(this.layers),Object.keys(this.fxQueue.post).length){this.clearScreen(this.fxCtx);for(var i=0;i<this.layers.length;++i)this.fxCtx.drawImage(this.layers[i].canvas,0,0)}this.executeFx(this.fxCtx,this.fxCtx,e,null,"post")}},{key:"prepareCanvas",value:function(e){var t=null,i=0,n="";for(i=0;i<this.layers.length;++i)t=this.layers[i],n=t.canvas.style.display,t.canvas.style.display="none",e.forEach(function(e){"image"===e.type&&t.drawImage(e.elt,0,0)}),this.clearScreen(t),t.canvas.style.display=n}},{key:"animate",value:function(e,t,i){console.log("animate");var n,r,a=s.a.getEffect(e),u=t.easing||"linear",l=t.when||"pre",h=this;if(t.context=i||this,void 0!==this.fxQueue[l][e]){console.warn("Fx",e,"already in progress, cannot execute twice");var c=new o.a;c.resolve(),n=c.promise}else a?(r=new a(t,this),r.setEasing(new s.a.getEasing(u)),n=r.start().then(function(){console.log("effect ended, need to stop it",e),delete h.fxQueue[l][e]}),this.fxQueue[l][e]=r):console.warn("Fx",e,"unknown: did you spell it correctly ?");return n}},{key:"stopAnimate",value:function(){console.log("TODO: need to stop animation")}},{key:"executeFx",value:function(e,t,i,n,s){var o;s=s||"pre";for(var r in this.fxQueue[s])o=this.fxQueue[s][r],o.process(e,t,i,n)}},{key:"clearDisplay",value:function(){console.log("clearFX Queue"),this.fxQueue.pre={},this.fxQueue.post={},this.clearAllScreens()}}]),e}();t.a=u},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(15),o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=function(){function e(t){n(this,e),console.log("[DisplayManager] Init()"),this.displays={}}return o(e,[{key:"addDisplay",value:function(e,t){return console.log("[Display Manager] adding display",e.name),this.displays[e.name]=new s.a(e,t),this.displays[e.name]}},{key:"getDisplay",value:function(e){return this.displays[e]}}]),e}();console.log("end DisplayManager"),t.a=new r},function(e,t,i){"use strict";var n=i(1),s={easeInQuad:function(e,t,i,n,s){return console.log("easeInQuad"),n*(t/=s)*t+i},easeOutBounce:function(e,t,i,n,s){return(t/=s)<1/2.75?n*(7.5625*t*t)+i:t<2/2.75?n*(7.5625*(t-=1.5/2.75)*t+.75)+i:t<2.5/2.75?n*(7.5625*(t-=2.25/2.75)*t+.9375)+i:n*(7.5625*(t-=2.625/2.75)*t+.984375)+i},swing:function(e,t,i,n,s){return.5-Math.cos(e*Math.PI)/2}};Object.keys(s).forEach(function(e){return n.a.addEasing(e,s[e])}),t.a=s},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(2),o=i(21),r=i(6),a=i(10),u=i(1),l=i(19),h=(i(0),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}());window.maps={};var c=function(){function e(t){n(this,e),this.options=t,this.src=t.src,this.tileWidth=t.tileWidth||64,this.tileHeight=t.tileHeight||32,this.width=t.width||1024,this.height=t.height||1024,this.tiles=t.tiles&&this._createTiles(t.tiles)||[],this.triggers=t.triggers||{},this.windows=t.windows||{},this.viewportX=t.viewportX||0,this.viewportY=t.viewportY||0,this.viewportW=t.viewportW||0,this.viewportH=t.viewportH||0,this.viewportTargetX=this.viewportTargetY=this.viewportSpeedX=this.viewsportSpeedY=this.viewportStartX=this.viewportStartY=0,this.viewportLimitX=230,this.viewportCenterX=307,this.viewportLimitY=154,this.viewportCenterY=230,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollTileOffsetX=0,this.scrollTileOffsetY=0,this.viewportLimits={x1:this.viewportLimitX,x2:this.viewportW-this.viewportLimitX,y1:this.viewportLimitY,y2:this.viewportLimitH-this.viewportLimitY},this.objects=[],this.friendBullets=[],this.enemies=[],this.platforms=[],this.name=t.name,this._calcNumTiles(!1),this.setBuffer(t.buffer),this.dataUrl=t.dataUrl,this.reverse=!1,this.firstRow=this.lastRow=this.firstCol=this.lastCol=0,this.isDebug=!1,this.srcBitmap=null,this.moving=!1,this.easing=u.a.getEasing(t.easing||"linear"),this.startMoveTime=null,this.duration=800,this.masterObject=null,this.currentWindow=null,this.startX=t.startX||0,this.startY=t.startY||0,window.maps[this.name]=this,this.mapEvent=new l.a(this),this.isDirty=!0}return h(e,[{key:"setStartXYFromMaster",value:function(){this.startX=this.masterObject.x,this.startY=this.masterObject.y}},{key:"resume",value:function(){console.log("avant",this.masterObject.running,this.masterObject.currentAnimName),this.masterObject.reset(),console.log("apres",this.masterObject.running,this.masterObject.currentAnimName),console.log("resuming",this.startX,this.startY),this.masterObject.x=this.startX,this.masterObject.y=this.startY}},{key:"reset",value:function(){this.masterObject=null,this.objects.length=0,this.friendBullets.length=0,this.enemies.length=0,this.platforms.length=0;for(var e in this.windows)this.windows[e].displayed=!1;for(var t in this.triggers)this.triggers[t].trigerred=!1;this.mapEvent.reset(),this.viewportX=this.options.viewportX||0,this.viewportY=this.options.viewportY||0,this.viewportW=this.options.viewportW||0,this.viewportH=this.options.viewportH||0,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollTileOffsetX=0,this.scrollTileOffsetY=0,this.firstCol=-this.viewportX/this.tileWidth,this.firstRow=-this.viewportY/this.tileHeight,this.lastCol=this.firstCol+this.numViewportCols,this.lastRow=this.firstRow+this.numViewportRows,this.isDirty=!0}},{key:"setBuffer",value:function(e){var t=this.numCols*this.numRows;this.map=new Uint8Array(e,0,t),this.tileTypes=new Uint8Array(e,t)}},{key:"setMasterObject",value:function(e){this.masterObject=e,e.x=this.startX,e.y=this.startY}},{key:"addObject",value:function(e){e.image||e.setImage(r.a.getResourceById(e.imageSrc)),e.setMap(this),this.objects.push(e),!0===e.master&&this.setMasterObject(e),1===e.collideGroup?this.enemies.push(e):2===e.collideGroup?this.friendBullets.push(e):3===e.collideGroup?(console.log("adding platform",e.id),this.platforms.push(e)):console.log("no collision or master for",e.id)}},{key:"setTilesSize",value:function(e,t){this.tileWidth=e,this.tileHeight=t}},{key:"setViewPort",value:function(e,t,i,n){this.viewportX=e,this.viewportY=t,this.viewportW=i,this.viewportH=n}},{key:"debug",value:function(e){this.isDebug=e,this.isDirty=!0}},{key:"moveObjects",value:function(){this.objects.forEach(function(e){3!==e.collideGroup&&e.move()})}},{key:"movePlatforms",value:function(){this.platforms.forEach(function(e){e.move()})}},{key:"move",value:function(){var e=(new Date).getTime(),t=e-this.startMoveTime,i=t/this.duration,n=void 0;!0===this.moving?(t>=this.duration?(this.moving=!1,this.viewportX=this.viewportTargetX,this.viewportY=this.viewportTargetY):(n=this.easing(i,t,0,1,this.duration),this.viewportX=this.viewportStartX+n*this.viewportSpeedX|0,this.viewportY=this.viewportStartY+n*this.viewportSpeedY|0),this.isDirty=!0):this.masterObject&&(this.checkMasterPosition(),this.checkForTriggers()),this.movePlatforms(),this.moveObjects()}},{key:"checkMasterPosition",value:function(){var e=null,t=null;this.masterObject&&!this.moving&&(this.viewportX&&this.masterObject.x+this.viewportX<=this.viewportLimitX?e=this.viewportX+this.viewportCenterX:-this.viewportX+this.viewportW-this.masterObject.x<=this.viewportLimitX&&(e=this.viewportX-this.viewportCenterX),this.viewportY&&this.masterObject.y+this.viewportY<=this.viewportLimitY?t=this.viewportY+this.viewportCenterY:-this.viewportY+this.viewportH-this.masterObject.y<=this.viewportLimitY&&(t=this.viewportY-this.viewportCenterY),null===e&&null===t||this.moveTo(null!==e?e:this.viewportX,null!==t?t:this.viewportY),null===e&&null===t||this.moveTo(null!==e?e:this.viewportX,null!==t?t:this.viewportY))}},{key:"checkCollisions",value:function(){this.masterObject&&this.masterObject.canCollide&&this.checkMasterToEnemiesCollisions(),this.checkMasterBulletsToEnemiesCollisions()}},{key:"checkForTriggers",value:function(){var e=this,t=this.masterObject.getHitBox();this.getTriggersForBox(this.masterObject.x+t.x,this.masterObject.y+t.y,this.masterObject.x+t.x2,this.masterObject.y+t.y2).forEach(function(t){t.triggered=!e.mapEvent.handleEvent(t)})}},{key:"moveTo",value:function(e,t){this.moving||(console.log("moveTo from",this.viewportX,"to",e),this.masterObject&&this.masterObject.savePosition(),this.viewportTargetX=e>0?0:e,this.viewportTargetY=t,this.startMoveTime=(new Date).getTime(),this.viewportSpeedX=e-this.viewportX|0,this.viewportSpeedY=t-this.viewportY|0,this.viewportStartX=this.viewportX,this.viewportStartY=this.viewportY,this.moving=!0)}},{key:"setNewSrc",value:function(e){this.src=e.src}},{key:"getSrc",value:function(){return this.src}},{key:"fallTest",value:function(e,t){var i=this.getTilePos(e,t);return this.tileTypes[i.x+i.y*this.numCols]===s.a.TYPE.WALL}},{key:"checkMasterBulletsToEnemiesCollisions",value:function(){var e=0,t=0,i=this.friendBullets.length,n=this.enemies.length;for(e=0;e<i;++e)for(t=0;t<n;++t)this.enemies[t]&&this.enemies[t].canCollideFriendBullet&&this.friendBullets[e]&&this.friendBullets[e].hitTest(this.enemies[t])}},{key:"checkMasterToEnemiesCollisions",value:function(){for(var e=0,t=this.enemies.length,i=!1;e<t&&!i;)i=this.enemies[e].hitTest(this.masterObject),e++;return i}},{key:"checkForPlatform",value:function(e,t,i){var n=e.getHitBox();n.x,sprite.x,n.y,sprite.y;return this.platforms.forEach(function(e){var t=e.getHitBox();e.x,t.x,e.y,t.y}),!1}},{key:"getTriggersForBox",value:function(e,t,i,n){var s=this.getTilePos(e,t),o=this.getTilePos(i,t),r=this.getTilePos(e,n),a=o.x,u=r.y,l=void 0,h=void 0,c=[],f=null;for(l=s.x;l<=a;l++)for(h=s.y;h<=u;h++)(f=this.triggers[h*this.numCols+l])&&!f.triggered&&c.push(f);return c}},{key:"setNextX",value:function(e,t){for(var i=!(e.vx>0),n=e.getHitBox(),s=e.y+n.y2,o=i?e.x+n.x-1:e.x+n.x2+1,r=e.y+n.y,a=this.getTilePos(o,r),u=!1,l=i?o:0;!u&&(i&&l>=e.vx||!i&&l<=e.vx);){for(var h=a.y*this.tileHeight;h<s;h+=this.tileHeight,a.y++)if(this.tileTypes[a.y*this.numCols+a.x]===t){u=!0;break}u||(l=i?a.x*this.tileWidth-o:++a.x*this.tileWidth-o),o=i?a.x*this.tileWidth-1:a.x*this.tileWidth,a=this.getTilePos(o,r)}return i&&e.vx>=l||!i&&e.vx<l?(e.x+=e.vx,!1):(console.log("**collision"),e.x+=l,!0)}},{key:"setNextYTop",value:function(e,t){var i=e.getHitBox,n=(e.x,i.x2,e.x+i.x),s=e.y+i.x2+1;this.getTilePos(n,s);e.y+=e.vy}},{key:"checkForTileType",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=e.getHitBox(),r=this.hitObjectTest(o.x+e.x+i,o.y+e.y+n,o.x2+e.x-i,o.y2+e.y-n,t);return!!r&&(s&&e.centerXOverTile(r),!0)}},{key:"hitObjectTest",value:function(e,t,i,n,s){var o=this.getTilePos(e,t),r=this.getTilePos(i,t),a=this.getTilePos(e,n),u=r.x,l=a.y,h=void 0,c=void 0;for(h=o.x;h<=u;h++)for(c=o.y;c<=l;c++)if(this.tileTypes[c*this.numCols+h]===s)return{x:h,y:c,tile:{x:h*this.tileWidth,y:c*this.tileHeight}};return!1}},{key:"drawTile",value:function(e,t,i,n,s){var o=this.tiles[e];s?t.drawImage(this.srcBitmap,o.offsetX+this.scrollOffsetX,o.offsetY+this.scrollOffsetY,this.scrollTileOffsetX,this.scrollTileOffsetY,i,n,this.scrollTileOffsetX,this.scrollTileOffsetY):t.drawImage(this.srcBitmap,o.offsetX,o.offsetY,this.tileWidth,this.tileHeight,i,n,this.tileWidth,this.tileHeight)}},{key:"_getScrollOffset",value:function(){var e=Math.abs(this.viewportX),t=Math.abs(this.viewportY);this.scrollOffsetX=e<this.tileWidth?e:e%this.tileWidth,this.scrollOffsetY=t<this.tileHeight?t:t%this.tileHeight,this.scrollTileOffsetX=this.tileWidth-this.scrollOffsetX,this.scrollTileOffsetY=this.tileHeight-this.scrollOffsetY}},{key:"draw",value:function(e,t){var i=void 0,n=void 0,s=void 0,o=void 0,a=0,u=0,l=0;if(this.srcBitmap||(this.srcBitmap=r.a.getResourceById(this.src)),i=n=s=o=0,!this.isDirty&&this.lastCol||this._getBoundariesTiles(t),this.isDirty||!this.lastCol){for(this._getScrollOffset(),i=this.firstRow,s=this.lastRow,l=0;i<s;i++){for(n=this.firstCol,o=this.lastCol,u=0;n<o;n++)a=this.map[i*this.numCols+n],a<255&&this.drawTile(a,e,u,l,this.viewportY&&i===this.firstRow||this.viewportX&&n===this.firstCol),this.viewportX&&n===this.firstCol?u+=this.scrollTileOffsetX:u+=this.tileWidth;this.viewPortY&&i===this.firstRow?l+=this.scrollTileOffsetY:l+=this.tileHeight}!0===this.isDebug&&this.showTileBehaviors(e,t),this.addNewObjectsFromWindow(),this.isDirty=!1}}},{key:"addNewObjectsFromWindow",value:function(){var e=this,t=(Math.abs(this.viewportX)/this.viewportW|0)+(Math.abs(this.viewportY)/this.viewportH|0),i=this.windows[t];!1===i.displayed&&(i.displayed=!0,i.items.forEach(function(t,i){var n=r.a.newResourceFromPool(t.type,t.spriteOptions);e.addObject(n),t.itemId&&e.mapEvent.addItem(t.itemId,n)}))}},{key:"drawObjects",value:function(e){var t=void 0,i=this.objects.length,n=this.objects;for(t=i-1;t>=0;t--)n[t].draw(e,this.isDebug)}},{key:"getTileAt",value:function(e,t){var i=void 0,n=void 0,s=void 0;return i=e/this.tileWidth|0,n=t/this.tileHeight|0,s=this.map[this.numCols*n+i],this.tiles[s]}},{key:"getTilePos",value:function(e,t){var i=void 0,n=void 0;return i=e/this.tileWidth|0,n=t/this.tileHeight|0,{x:i,y:n}}},{key:"_calcNumTiles",value:function(){this.numCols=this.width/this.tileWidth|0,this.numRows=this.height/this.tileHeight|0,this.numViewportCols=this.viewportW/this.tileWidth|0,this.numViewportRows=this.viewportH/this.tileHeight|0}},{key:"_getBoundariesTiles",value:function(e){e?(this.firstCol=0,this.firstRow=0,this.lastCol=this.width/this.tileWidth|0,this.lastRow=this.height/this.tileHeight|0):(this.firstCol=Math.floor(-this.viewportX/this.tileWidth),this.firstRow=Math.floor(-this.viewportY/this.tileHeight),this.lastCol=this.firstCol+this.numViewportCols,this.lastRow=this.firstRow+this.numViewportRows,this.viewportX%this.tileWidth&&this.lastCol++,this.viewportY%this.tileHeight&&this.lastRow++)}},{key:"notify",value:function(e,t){a.a.notify(e,t)}},{key:"removeObject",value:function(e){var t=this.objects.indexOf(e);t>-1&&this.objects.splice(t,1),t=this.enemies.indexOf(e),t>-1?this.enemies.splice(t,1):(t=this.friendBullets.indexOf(e))>-1&&this.friendBullets.splice(t,1)}},{key:"scheduleSprite",value:function(e,t,i){var n=this,s=r.a.newResourceFromPool(e,t);return i?setTimeout(function(){n.addObject(s)},i):this.addObject(s),s}},{key:"handleWave",value:function(e){var t=e.size,i=new o.a(e),n=0,s=0;for(e.spriteOptions.wave=i,n=0;n<t;n++)this.scheduleSprite(e.spriteId,e.spriteOptions,s),s+=e.delay||0;return!1}},{key:"showTileBehaviors",value:function(e){var t=void 0,i=void 0,n=void 0,s=void 0,o=0,r=0,a=[null,null,"rgba(240,0,0,.6)","rgba(0,0,240,.6)"],u=void 0,l=void 0;for(t=i=n=s=0,t=this.firstRow,n=this.lastRow,r=0;t<n;t++){for(i=this.firstCol,s=this.lastCol,o=0;i<s;i++)u=this.viewportX&&i===this.firstCol?this.scrollTileOffsetX:this.tileWidth,l=this.viewPortY&&t===this.firstRow?this.scrollTileOffsetY:this.tileHeight,this.tileTypes[t*this.numCols+i]>1&&(e.fillStyle=a[this.tileTypes[t*this.numCols+i]],e.beginPath(),e.moveTo(o,r),e.lineTo(o+u,r),e.lineTo(o+u,r+l),e.lineTo(o,r+l),e.lineTo(o,r),e.closePath(),e.fill()),this.viewportX&&i===this.firstCol?o+=this.scrollTileOffsetX:o+=this.tileWidth;this.viewPortY&&t===this.firstRow?r+=this.scrollTileOffsetY:r+=this.tileHeight}}},{key:"getObjectsList",value:function(){this.objects.forEach(function(e,t){console.log("["+t+"]",e.type,"("+e.id+")")})}},{key:"toString",value:function(){var e=0,t=this.tiles.length,i={src:this.src,viewportX:0,viewportY:0,viewportW:this.viewportW,viewportH:this.viewportH,width:this.width,height:this.height,tileWidth:this.tileWidth,tileHeight:this.tileHeight,map:this.map,bjects:this.objects,tiles:[]};for(e=0;e<t;e++)this.tiles[e],i.tiles.push("new Tile({offsetX: tile.offsetX,offsetY: tile.offsetY,width: tile.width,height: tile.height,inertia: tile.inertia,upCollide: tile.upCollide,downCollide: tile.downCollide}),");return JSON.stringify(i)}},{key:"_createTiles",value:function(e){var t=[];return e.forEach(function(e){t.push(new s.a(e))}),t}},{key:"resize",value:function(e,t){var i=null,n={},s={},o=null,r=null,a=null,u=null;if("bottomleft"!==e)throw"resize not support for direction"+e;var l=(t.newWidth,this.width,t.newHeight-this.height),h=t.newWidth/this.tileWidth|0,c=t.newHeight/this.tileHeight|0,f=(this.numCols,c-this.numRows),p=this.width/this.viewportW|0,d=this.height/this.viewportH|0,v=(t.newWidth,this.viewportW,t.newHeight/this.viewportH|0),y=v-d;i=new ArrayBuffer(h*c*2),o=new Uint8Array(i,0,c*h),r=new Uint8Array(i,c*h,c*h);for(var m=f;m<c;m++)for(var g=0;g<this.numCols;g++)o[m*h+g]=this.map[m*h+g],r[m*h+g]=this.tileTypes[m*h+g],this.triggers[m*h+g]&&(a=Object.assign({},!0,this.triggers[m*h+g]),a.spriteOptions&&(a.spriteOptions.y+=l),n[m*h+g]=a);this.setBuffer(i),this.width=t.newWidth,this.height=t.newHeight,this.triggers=n,this._calcNumTiles();for(var b=y;b<v;++b)for(var w=0;w<p;++w)if(this.windows[b*p+w]){u=this.windows[b*p+w].items;for(var k=0;k<u.length;++k)a=Object.assign({},u[k]),a.spriteOptions&&(a.spriteOptions.y+=l);s[b*p+w]={displayed:!1,items:u.slice(0)}}this.windows=s}}]),e}();t.a=c},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),o=function(){function e(t){n(this,e),console.log("[MapEvent] init with map"),this.map=t||null,this.reset()}return s(e,[{key:"reset",value:function(){this.switches={},this.events=[],this.items={}}},{key:"addItem",value:function(e,t){this.items[e]=t}},{key:"getItem",value:function(e){return this.items[e]}},{key:"setSwitch",value:function(e,t){this.switches[e]=t}},{key:"toggleSwitch",value:function(e){this.setSwitch(e,void 0===this.switches[e]||!this.switches[e])}},{key:"getSwitch",value:function(e){return this.switches[e]||!1}},{key:"checkConditions",value:function(e){var t,i,n=e.conditions,s=null,o=!0;if(n){for(t=0,i=n.length;t<i;t++){switch(s=n[t],s.type){case"time":break;case"switch":o=this.getSwitch(s.id)===s.status}if(!o)break}return o}return!0}},{key:"handleAction",value:function(e){var t;switch(e.type){case"toggleSwitch":t=e.sprite,t.toggleSwitch(),this.toggleSwitch(t.id);break;default:console.log("[MapEvent] non-handled action type",e.type)}}},{key:"handleEvent",value:function(e){var t=e.type,i=null;if(!this.checkConditions(e))return!0;switch(t){case"cp":this.map.setStartXYFromMaster();break;case"message":this.map.notify("game:message",{message:e.message});break;case"wave":return this.map.handleWave(Object.assign({},e));case"explosion":this.map.scheduleSprite(e.spriteId,e.spriteOptions,0),i=this.getItem(e.targetId),i.destroy();break;default:console.log("non-handled Event",e.type)}}},{key:"triggerEvent",value:function(e){this.events.push(e)}},{key:"isEventTriggered",value:function(e){return this.events.indexOf(e)>-1}}]),e}();t.a=o},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(4),a=i(1),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(n)},h=function(e){function t(e,i){n(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return o.imageSrc=i.imageSrc,o.w=i.w||320,o.h=i.h||18,o.pixelHeight=0,o.maxLines=Math.floor(o.h/(o.charHeight+o.lineSpacing)),o.easing=a.a.getEasing(i.easing||"linear"),o.imageSrc=i.imageSrc||"image not set",o.buffer=null,o.image=null,o.scrolling=!1,o.text=i.text||"BitmapText",o.scrollOffsetX=i.scrollOffsetX||0,o.scrollOffsetY=i.scrollOffsetY||0,o.textArray=[],o.setFontParams(i),o}return o(t,e),u(t,[{key:"createBuffer",value:function(e){var t=this.w,i=this.textArray.length*(this.charHeight+this.lineSpacing);this.buffer=e.getBuffer(t,i)}},{key:"clearBuffer",value:function(){this.currentScene.display.clearScreen(this.buffer)}},{key:"setFontParams",value:function(e){this.lineSpacing=e.lineSpacing||2,this.letterSpacing=e.letterSpacing||2,this.charWidth=e.charWidth||16,this.charHeight=e.charHeight||18,this.maxCharPerLine=Math.floor(this.w/(this.charWidth+this.letterSpacing)),this.maxPixels=this.maxCharPerLine*(this.charWidth+this.letterSpacing),this.offsetX=e.offsetX||0,this.offsetY=e.offsetY||0,this.bmStartX=e.bmStartX||0,this.bmStartY=e.bmStartY||0}},{key:"reset",value:function(){l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"reset",this).call(this),this.setTextPosition()}},{key:"getNextLineLength",value:function(e,t){for(var i=0;i<e.length&&e[i]!==t;)i++;return i}},{key:"getLines",value:function(){var e=this.text,t="",i=!1,n=0,s=0;for(this.textArray.length=0;!i;)e=e.replace(/^\n/,""),n=this.getNextLineLength(e,"\n"),n?(t=e.substr(0,n),t.length<=this.maxCharPerLine?e=e.substr(n):(t=e.substr(0,this.maxCharPerLine),e=e.substr(this.maxCharPerLine)),this.textArray.push({text:t,x:"center"===this.align?Math.floor((this.maxPixels-t.length*(this.charWidth+this.letterSpacing))/2):0,y:s}),s+=this.charHeight+this.lineSpacing):i=!0;this.pixelHeight=this.textArray.length*(this.charHeight+this.lineSpacing)}},{key:"scrollFromBottom",value:function(e,t){this.scrollOffsetY=this.h,this.scrollText({callback:t,duration:e,targetOffsetX:0,targetOffsetY:this.h-this.pixelHeight})}},{key:"scrollFromTop",value:function(e,t){this.scrollOffsetY=-this.pixelHeight,this.scrollText({callback:t,duration:e,targetOffsetX:0,targetOffsetY:0})}},{key:"scrollText",value:function(e){this.scrolling||(console.log("starting scrolling"),this.scrolling=!0,this.callback=e.callback&&e.callback.bind(this)||null,this.duration=e.duration||1e4,this.targetOffsetX=e.targetOffsetX,this.targetOffsetY=e.targetOffsetY,this.startX=this.scrollOffsetX,this.startY=this.scrollOffsetY,this.speedX=this.targetOffsetX-this.startX|0,this.speedY=this.targetOffsetY-this.startY|0,this.startMoveTime=(new Date).getTime())}},{key:"setTextPosition",value:function(){}},{key:"move",value:function(){var e=(new Date).getTime(),t=e-this.startMoveTime,i=t/this.duration,n=void 0;!0===this.scrolling&&(t>=this.duration?(this.scrolling=!1,this.scrollOffsetX=this.targetOffsetX,this.scrollOffsetY=this.targetOffsetY,this.callback&&this.callback()):(n=this.easing(i,t,0,1,this.duration),this.scrollOffsetX=this.startX+n*this.speedX|0,this.scrollOffsetY=this.startY+n*this.speedY|0))}},{key:"getCharOffset",value:function(e){return(e.toUpperCase().charCodeAt(0)-65)*this.offsetX}},{key:"drawLine",value:function(e){var t=e.x,i=e.y,n=0,s=0,o=e.text.length;for(n=0;n<o;++n)32!==e.text[n].charCodeAt(0)&&(s=this.getCharOffset(e.text[n]),this.buffer.drawImage(this.image,s,this.bmStartY,this.charWidth,this.charHeight,t,i,this.charWidth,this.charHeight)),t+=this.letterSpacing+this.charWidth}},{key:"renderText",value:function(){var e=0,t=0,i=void 0;for(t=this.textArray.length,e=0;e<t;++e)i=this.textArray[e],this.drawLine(i)}},{key:"setText",value:function(e){this.text=e,this.getLines(),this.buffer?this.clearBuffer():this.createBuffer(this.currentScene.display),this.renderText(this.text)}},{key:"setImage",value:function(e){this.image=e}},{key:"setScene",value:function(e){l(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"setScene",this).call(this,e),this.setText(this.text)}},{key:"draw",value:function(e,t){var i,n,s;if(this.visible){if(this.scrollOffsetY>=0?(i=this.scrollOffsetY,n=this.h-i,s=0):(i=0,n=this.h,s=Math.abs(this.scrollOffsetY)),!this.isFxQueueEmpty())throw this.executeFx(e),"TODO: drawing of bitmapText";e.drawImage(this.buffer.canvas,0,s,this.w,n,this.x+this.scrollOffsetX,this.y+i,this.w,n),t&&this.showObjectBox(e)}}}]),t}(r.a);t.a=h},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(6),o=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),r=function(){function e(t){n(this,e),this.counter=t.size,this.type=t.afterDestroy,this.data=t.afterDestroyData}return o(e,[{key:"remove",value:function(e){--this.counter||this.destroy(e)}},{key:"destroy",value:function(e){switch(this.type){case"reward":if(this.data){var t=new(s.a.getResourceById("SmallItem"))({x:e.x+24,y:e.y-20,vy:-2,data:{itemType:this.data}});e.currentMap.addObject(t)}break;default:throw this.type}}}]),e}();t.a=r},function(e,t,i){(function(t,n){!function(t,i){e.exports=i()}(0,function(){"use strict";function e(e){return"function"==typeof e||"object"==typeof e&&null!==e}function s(e){return"function"==typeof e}function o(e){W=e}function r(e){V=e}function a(){return void 0!==H?function(){H(l)}:u()}function u(){var e=setTimeout;return function(){return e(l,1)}}function l(){for(var e=0;e<q;e+=2){(0,$[e])($[e+1]),$[e]=void 0,$[e+1]=void 0}q=0}function h(e,t){var i=arguments,n=this,s=new this.constructor(f);void 0===s[ee]&&j(s);var o=n._state;return o?function(){var e=i[o-1];V(function(){return E(o,s,e,n._result)})}():O(n,s,e,t),s}function c(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var i=new t(f);return w(i,e),i}function f(){}function p(){return new TypeError("You cannot resolve a promise with itself")}function d(){return new TypeError("A promises callback cannot return that same promise.")}function v(e){try{return e.then}catch(e){return se.error=e,se}}function y(e,t,i,n){try{e.call(t,i,n)}catch(e){return e}}function m(e,t,i){V(function(e){var n=!1,s=y(i,t,function(i){n||(n=!0,t!==i?w(e,i):x(e,i))},function(t){n||(n=!0,_(e,t))},"Settle: "+(e._label||" unknown promise"));!n&&s&&(n=!0,_(e,s))},e)}function g(e,t){t._state===ie?x(e,t._result):t._state===ne?_(e,t._result):O(t,void 0,function(t){return w(e,t)},function(t){return _(e,t)})}function b(e,t,i){t.constructor===e.constructor&&i===h&&t.constructor.resolve===c?g(e,t):i===se?(_(e,se.error),se.error=null):void 0===i?x(e,t):s(i)?m(e,t,i):x(e,t)}function w(t,i){t===i?_(t,p()):e(i)?b(t,i,v(i)):x(t,i)}function k(e){e._onerror&&e._onerror(e._result),T(e)}function x(e,t){e._state===te&&(e._result=t,e._state=ie,0!==e._subscribers.length&&V(T,e))}function _(e,t){e._state===te&&(e._state=ne,e._result=t,V(k,e))}function O(e,t,i,n){var s=e._subscribers,o=s.length;e._onerror=null,s[o]=t,s[o+ie]=i,s[o+ne]=n,0===o&&e._state&&V(T,e)}function T(e){var t=e._subscribers,i=e._state;if(0!==t.length){for(var n=void 0,s=void 0,o=e._result,r=0;r<t.length;r+=3)n=t[r],s=t[r+i],n?E(i,n,s,o):s(o);e._subscribers.length=0}}function C(){this.error=null}function S(e,t){try{return e(t)}catch(e){return oe.error=e,oe}}function E(e,t,i,n){var o=s(i),r=void 0,a=void 0,u=void 0,l=void 0;if(o){if(r=S(i,n),r===oe?(l=!0,a=r.error,r.error=null):u=!0,t===r)return void _(t,d())}else r=n,u=!0;t._state!==te||(o&&u?w(t,r):l?_(t,a):e===ie?x(t,r):e===ne&&_(t,r))}function P(e,t){try{t(function(t){w(e,t)},function(t){_(e,t)})}catch(t){_(e,t)}}function M(){return re++}function j(e){e[ee]=re++,e._state=void 0,e._result=void 0,e._subscribers=[]}function A(e,t){this._instanceConstructor=e,this.promise=new e(f),this.promise[ee]||j(this.promise),X(t)?(this._input=t,this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?x(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&x(this.promise,this._result))):_(this.promise,F())}function F(){return new Error("Array Methods must be provided an Array")}function R(e){return new A(this,e).promise}function L(e){var t=this;return new t(X(e)?function(i,n){for(var s=e.length,o=0;o<s;o++)t.resolve(e[o]).then(i,n)}:function(e,t){return t(new TypeError("You must pass an array to race."))})}function D(e){var t=this,i=new t(f);return _(i,e),i}function N(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function I(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function G(e){this[ee]=M(),this._result=this._state=void 0,this._subscribers=[],f!==e&&("function"!=typeof e&&N(),this instanceof G?P(this,e):I())}function B(){var e=void 0;if(void 0!==n)e=n;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(e){throw new Error("polyfill failed because global object is unavailable in this environment")}var t=e.Promise;if(t){var i=null;try{i=Object.prototype.toString.call(t.resolve())}catch(e){}if("[object Promise]"===i&&!t.cast)return}e.Promise=G}var Y=void 0;Y=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var X=Y,q=0,H=void 0,W=void 0,V=function(e,t){$[q]=e,$[q+1]=t,2===(q+=2)&&(W?W(l):Z())},U="undefined"!=typeof window?window:void 0,z=U||{},J=z.MutationObserver||z.WebKitMutationObserver,Q="undefined"==typeof self&&void 0!==t&&"[object process]"==={}.toString.call(t),K="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,$=new Array(1e3),Z=void 0;Z=Q?function(){return function(){return t.nextTick(l)}}():J?function(){var e=0,t=new J(l),i=document.createTextNode("");return t.observe(i,{characterData:!0}),function(){i.data=e=++e%2}}():K?function(){var e=new MessageChannel;return e.port1.onmessage=l,function(){return e.port2.postMessage(0)}}():void 0===U?function(){try{var e=i(44);return H=e.runOnLoop||e.runOnContext,a()}catch(e){return u()}}():u();var ee=Math.random().toString(36).substring(16),te=void 0,ie=1,ne=2,se=new C,oe=new C,re=0;return A.prototype._enumerate=function(){for(var e=this.length,t=this._input,i=0;this._state===te&&i<e;i++)this._eachEntry(t[i],i)},A.prototype._eachEntry=function(e,t){var i=this._instanceConstructor,n=i.resolve;if(n===c){var s=v(e);if(s===h&&e._state!==te)this._settledAt(e._state,t,e._result);else if("function"!=typeof s)this._remaining--,this._result[t]=e;else if(i===G){var o=new i(f);b(o,e,s),this._willSettleAt(o,t)}else this._willSettleAt(new i(function(t){return t(e)}),t)}else this._willSettleAt(n(e),t)},A.prototype._settledAt=function(e,t,i){var n=this.promise;n._state===te&&(this._remaining--,e===ne?_(n,i):this._result[t]=i),0===this._remaining&&x(n,this._result)},A.prototype._willSettleAt=function(e,t){var i=this;O(e,void 0,function(e){return i._settledAt(ie,t,e)},function(e){return i._settledAt(ne,t,e)})},G.all=R,G.race=L,G.resolve=c,G.reject=D,G._setScheduler=o,G._setAsap=r,G._asap=V,G.prototype={constructor:G,then:h,catch:function(e){return this.then(null,e)}},G.polyfill=B,G.Promise=G,G})}).call(t,i(41),i(43))},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=i(24);i.d(t,"Game",function(){return n.a});var s=i(14);i.d(t,"Pool",function(){return s.a});var o=i(39);i.d(t,"Scene",function(){return o.a});var r=i(6);i.d(t,"ResourceManager",function(){return r.a});var a=i(4);i.d(t,"Object",function(){return a.a});var u=i(12);i.d(t,"Sprite",function(){return u.a});var l=i(13);i.d(t,"Text",function(){return l.a});var h=i(21);i.d(t,"Wave",function(){return h.a});var c=i(38);i.d(t,"Menu",function(){return c.a});var f=i(37);i.d(t,"Hud",function(){return f.a});var p=i(20);i.d(t,"BitmapText",function(){return p.a});var d=i(36);i.d(t,"Circle",function(){return d.a});var v=i(10);i.d(t,"NotificationManager",function(){return v.a});var y=i(18);i.d(t,"Map",function(){return y.a});var m=i(19);i.d(t,"MapEvent",function(){return m.a});var g=i(1);i.d(t,"FX",function(){return g.a});var b=i(17);i.d(t,"Easing",function(){return b.a});var w=i(9);i.d(t,"InputManager",function(){return w.a});var k=i(16);i.d(t,"DisplayManager",function(){return k.a});var x=i(15);i.d(t,"Display",function(){return x.a});var _=i(5);i.d(t,"AudioManager",function(){return _.a});var O=i(11);i.d(t,"Binary",function(){return O.a});var T=i(7);i.d(t,"Dom",function(){return T.a})},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(6),o=(i(11),i(16)),r=i(5),a=i(10),u=i(9),l=i(40),h=i.n(l),c=i(7),f=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),p=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};n(this,e),console.log("[Game] Init()"),this.debug=t.debug,this.name=t.name;var i=t.target&&new c.a(t.target);this.target=i&&i.length&&i[0]||new c.a("div").appendTo("body")[0],this.showFps=void 0!==t.showFps&&t.showFps,this.showFps&&h()({width:50,height:50}),this.width=t.width||1024,this.height=t.height||768,this.resources=t.resources,this.display=null,this.scene=null,this.running=!1,this._initEvents(),this.createDisplay({name:"main",width:t.width,height:t.height,numLayers:t.numLayers||2},this.target),this.toggleSound(void 0===t.sound||t.sound),!1==!!t.sound&&(console.warn("sound disabled: skipping audio resources"),s.a.skipResources.push("audio")),this.timeout=null,this.animFrame=null,this.bindEvents("*")}return f(e,[{key:"bindEvents",value:function(e){a.a.listen(e,this.onEvent.bind(this))}},{key:"onEvent",value:function(e){}},{key:"toggleSound",value:function(e){this.sound=e,r.a.toggleSound(e)}},{key:"createDisplay",value:function(e,t){this.display=o.a.addDisplay(e,t)}},{key:"_initEvents",value:function(){u.a._init(this,{joystick:!0})}},{key:"onReady",value:function(e){console.log("**this",this),e.apply(this)}},{key:"setScene",value:function(e,t){this.scene&&(console.log("need to stop scene"),this.stopScene(),this.scene.stop()),e?(this.scene=e,this.scene.setDisplay(this.display),this.display.clearDisplay(),console.log("**autoStart",t),!1!==t&&this.startScene()):console.warn("attempt to set non-existing scene:",e)}},{key:"_renderSceneLoop",value:function(e){var t=this.scene;!0!==this.debug&&this.running&&(u.a.playingEvents&&u.a.nextRecordedEvents(),this.animFrame=window.requestAnimationFrame(this._renderSceneLoop.bind(this)),this.display.renderScene(t),t.hudScene,u.a.recording&&u.a.recordEvents())}},{key:"_runSceneLoop",value:function(){var e=this.scene;this.running||(this.running=!0),e.run(),!0!==this.debug&&this.running&&(this.timeout=setTimeout(this._runSceneLoop.bind(this),16))}},{key:"togglePauseGame",value:function(){this.running?(console.log("pausing game"),this.running=!1,this.scene.pause(),this.display.renderScene(this.scene),this.stopScene()):(console.log("un-pausing game"),this.running=!0,this.scene.unpause(),this._runSceneLoop(),this._renderSceneLoop())}},{key:"startScene",value:function(){console.log("[Game] startScene");var e=this;this.scene?(console.log("[Game] loading scene"),this.scene.load().then(function(){console.log("[Game] Scene",e.scene.name,"loaded: starting run & render loops"),e.scene.start(),e._runSceneLoop(),e._renderSceneLoop()})):console.log("[Game] nothing to start: no scene selected!!")}},{key:"stopScene",value:function(){this.running=!1,console.log("[Game] Scene stopped, stopping run & render loops"),this.animFrame&&(window.cancelAnimationFrame(this.animFrame),this.animFrame=null),this.timeout&&(clearTimeout(this.timeout),this.timeout=null)}}]),e}();t.a=p},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(8),a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(n)},l=function(e){function t(e,i){n(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return o.callback=e.callback,o.diff=o.endValue-o.startValue,o}return o(t,e),a(t,[{key:"process",value:function(e,i,n){return u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"process",this).call(this),this.callback(this.startValue+this.animProgress*this.diff),this.ended}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(8),a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(n)},l=function(e){function t(e,i){n(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({startValue:0,endValue:1},e),i));return o.startOpacity=void 0!==o.startValue?e.startValue:0,o.endOpacity=void 0!==o.endValue?e.endValue:1,o.diff=o.endValue-o.startValue,o}return o(t,e),a(t,[{key:"start",value:function(){return this.currentOpacity=1,u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this)}},{key:"process",value:function(e,i,n){return u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"process",this).call(this),this.currentOpacity=this.startValue+this.animProgress*this.diff,n.setOpacity(this.currentOpacity),this.ended}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(8),a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(n)},l=function(e){function t(e,i){n(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({startValue:.002,endValue:1},e),i));return o.buffer=i.getBuffer(o.width,o.height),o.startWidth=null,o.ratio=o.width/o.height,o.diff=o.endValue*o.width-o.startValue*o.width,console.log("got ratio=",o.ratio,"for",o.width,o.height,"diff",o.diff),o}return o(t,e),a(t,[{key:"start",value:function(){return this.startWidth=this.startValue*this.width,console.log("***",this.startWidth),u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this)}},{key:"process",value:function(e,i){u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"process",this).call(this);var n=this.startWidth+this.animProgress*this.diff,s=n/this.ratio;return this.buffer.drawImage(e.canvas,0,0,0|n,0|s),e.drawImage(this.buffer.canvas,0,0,0|n,0|s,0,0,this.width,this.height),this.ended}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(8),a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function e(t,i,n){null===t&&(t=Function.prototype);var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,i,n)}if("value"in s)return s.value;var r=s.get;if(void 0!==r)return r.call(n)},l=function(e){function t(e,i){n(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,Object.assign({startValue:0,endValue:2*Math.PI,loop:!0},e),i));return o.startAngle=void 0!==o.startAngle?e.startValue:0,o.endAngle=void 0!==o.endAngle?e.endValue:1,o.diff=o.endValue-o.startValue,o}return o(t,e),a(t,[{key:"start",value:function(){return this.currentAngle=this.startAngle,u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this)}},{key:"process",value:function(e,i,n){return u(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"process",this).call(this),this.currentAngle=this.startValue+this.animProgress*this.diff,n.setAngle(this.currentAngle),this.ended}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(30),o=i(34),r=i(33),a=i(31),u=i(32),l=i(35),h=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),c={},f=function(){function e(){n(this,e)}return h(e,[{key:"addBehavior",value:function(e,t){c[e]=t}},{key:"getBehavior",value:function(e){return c[e]}}]),e}(),p=new f;p.addBehavior("ground",s.a),p.addBehavior("inout",a.a),p.addBehavior("simplefall",o.a),p.addBehavior("weapon",l.a),p.addBehavior("player",r.a),p.addBehavior("path",u.a),t.a=p},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(3),a=i(2),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function(e){function t(e,i,o){n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,o));return r.direction=o.direction||"right",r.direction.match("left")&&(r.sprite.vx=-r.sprite.vx),r.direction.match("top")&&(r.sprite.vy=-r.sprite.vy),r}return o(t,e),u(t,[{key:"onMove",value:function(e){var t=this.sprite,i=t.currentMap,n=t.x+t.vx,s=t.y+t.vy,o=t.getHitBox(),r=t.vx>0?o.x2:o.x;i.hitObjectTest(n+r,s+o.y,n+r,s+o.y,a.a.TYPE.WALL)?(t.vx=-t.vx,this.onVXChange&&this.onVXChange(t.vx)):i.hitObjectTest(n+o.x,s+o.y2+2,n+o.x2,s+o.y2+2,a.a.TYPE.AIR)?(t.vx=-t.vx,this.onVXChange&&this.onVXChange(t.vx)):i.hitObjectTest(n+o.x,s+o.y2+2,n+o.x2,s+o.y2+2,a.a.TYPE.LADDER)&&(t.vx=-t.vx,this.onVXChange&&this.onVXChange(t.vx)),t.x+=t.vx,t.y+=t.vy}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(3),a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function(e){function t(e,i,o){n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,o));return r.startY=e.y,r.startX=e.x,r.maxX=o.minX||0,r.maxY=o.minY||0,r}return o(t,e),a(t,[{key:"onMove",value:function(e){var t=this.sprite,i=Math.abs(t.y-this.startY),n=Math.abs(t.x-this.startX);i>this.maxY&&(t.vy=-t.vy,this.onVYChange&&this.onVYChange()),n>this.maxX&&(t.vx=-t.vx,this.onVXChange&&this.onVXChange()),t.x+=t.vx,t.y+=t.vy}}]),t}(r.a);t.a=u},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function r(e){return"number"==typeof e?e?e<0?-1:1:e===e?0:NaN:NaN}var a=i(3),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function(e){function t(e,i,o){n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,o));return r.startY=e.y,r.startX=e.x,r.currentNode=0,r.offset=2,r.nodes=o.nodes,r.reverse=o.reverse||!1,r.dirX=0,r.dirY=0,r.numNodes=r.nodes.length/2,r}return o(t,e),u(t,[{key:"onMove",value:function(e){var t=this.sprite,i=this.currentNode,n=this.nodes[i],s=this.nodes[i+1];if(this.offset>0?(t.x+=n,t.y+=s):(t.x-=n,t.y-=s),n&&(this.dirX&&r(this.dirX)!==r(n)&&this.onVXChange&&this.onVXChange(),this.dirX=n),s&&(this.dirY&&r(this.dirY)!==r(s)&&this.onVYChange&&this.onVYChange(),this.dirY=s),this.currentNode+=this.offset,this.currentNode>=this.nodes.length||this.currentNode<0){if(!this.reverse)return void(t.moving=!1);this.onVXChange&&(this.dirX=0,this.onVXChange()),this.onVYChange&&(this.dirY=0,this.onVYChange()),this.currentNode=this.currentNode<0?0:this.nodes.length-2,this.offset=-this.offset}}}]),t}(a.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(3),a=i(5),u=i(2),l=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),h=function(e){function t(e,i,o){n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,o));return r.direction=o.direction||"right",r.currentMovement=o.startMovement||"",r.lookDirection=o.lookDirection||"left",r.climbVY=2,r.jumping=!1,r.firing=!1,r.fromLadder=!1,r.sideHit=!1,r}return o(t,e),l(t,[{key:"onMove",value:function(e){var t=this.Input;if("falling"===this.currentMovement||this.currentMovement.match(/jump/)||this.firing)this.currentMovement.match(/jump/)?(t.getKeyStatus(t.keys.CTRL,!0)&&this.handleFire(),this.fromLadder||!0!==t.getKeyStatus(t.keys.UP)||this.goUpOrClimb(!0),this.jump(this.lookDirection)):this.currentMovement.match("fire")||this.currentMovement.match("climb")||(console.log("cas 2.2",this.currentMovement),this.fall());else if(!0===t.getKeyStatus(t.keys.LEFT)?!0===t.getKeyStatus(t.keys.UP)?this.startJump("left"):this.walkLeft():!0===t.getKeyStatus(t.keys.RIGHT)?!0===t.getKeyStatus(t.keys.UP)?(this.startJump("right"),console.log("startJump right",this.fromLadder)):this.walkRight():!0===t.getKeyStatus(t.keys.UP)?this.goUpOrClimb(!1):!0===t.getKeyStatus(t.keys.DOWN)?this.goDownOrClimb(0):"climb"!==this.currentMovement?this.currentMovement.match("fire")||this.idle():this.stopClimbing(),!0===t.getKeyStatus(t.keys.CTRL,!0))switch(this.currentMovement){case"faceWall":this.switchAbove&&this.getMapEvent().handleAction({type:"toggleSwitch",sprite:this.switchAbove});break;case"climb":if(!this.lookDirection)break;case"idle":case"walk_right":case"walk_left":this.handleFire();break;case"down":break;default:console.log("unhandle fire"),console.log(this.currentMovement)}}},{key:"handleFire",value:function(){var e=this;console.log("fire direction",this.lookDirection),this.firing||this.sprite.onEvent("fire",{direction:this.lookDirection})&&(this.firing=!0,this.previousMovement=this.currentMovement,this.sprite.storeCurrentAnim(),this.sprite.setAnimation("fire"+this.lookDirection,function(){e.firing=!1,this.restorePreviousAnim()}))}},{key:"walk",value:function(e){var t=this.sprite,i=t.getHitBox(),n=void 0,s=void 0,o=void 0;return this.currentMovement="walk_"+e,this.vy=0,t.currentAnimName="walk"+e.charAt(0).toUpperCase()+e.slice(1),o="step_"+e,this.lookDirection=e,this.vx="left"===e?-2:2,n=t.x+this.vx,s=t.y+this.vy,t.currentMap.hitObjectTest(n+i.x,s+i.y,n+i.x2,s+i.y2,u.a.TYPE.WALL)?this.idle():(t.startAnimation(),t.currentFrameNum===t.previousFrameNum||3!==t.currentFrameNum&&7!==t.currentFrameNum||a.a.play(o)),t.x+=this.vx,t.y+=this.vy,this.fallTest(),0}},{key:"walkLeft",value:function(){"climb"!==this.currentMovement?this.walk("left"):this.lookDirection="left"}},{key:"walkRight",value:function(){"climb"!==this.currentMovement?this.walk("right"):this.lookDirection="right"}},{key:"startJump",value:function(e){var t=this.sprite,i=this;this.jumping?(i.readyToJump=!0,this.jumping=!0,i.currentMovement="jump"+e,this.vx="left"===e?-2:2,this.vy=-4,this.gravity=.098,this.sprite.setAnimation("jump"+e)):(console.log("starting jump",t.y),this.readyToJump=!1,this.currentMovement="startjump",this.vx="left"===e?-2:2,this.vy=-4,this.gravity=.098,console.log("startJump",this.vy),t.setAnimation("goDown"+e,function(){console.log("end goDownLeft, ready to jump",this.vy,this.y),i.readyToJump=!0,i.currentMovement="jump"+e,i.jumping=!0,this.setAnimation("jump"+e)})),this.lookDirection=this.direction=e,this.sideHit=!1,a.a.play("jump")}},{key:"jump",value:function(e){var t=this.sprite,i=t.x+Math.ceil(this.vx),n=t.y+Math.ceil(this.vy),s=t.getHitBox(),o=null,r=null,l=!1;return this.readyToJump?this.currentMovement.match(/jump/)&&(o=t.currentMap.hitObjectTest(i+s.x,t.y+s.y,i+s.x2,t.y+s.y2,u.a.TYPE.WALL),o&&(this.sideHit=!0,l=!0,"right"===this.direction?t.x=o.tile.x-s.x2-s.x-1:t.x=o.tile.x+t.currentMap.tileWidth),r=t.currentMap.hitObjectTest(t.x+s.x,n+s.y,t.x+s.x2,n+s.y2,u.a.TYPE.WALL))?this.vy<0?(console.log("[PlayerMove] Top collision, reversing vy!"),void(this.sideHit?this.vy=-this.vy:this.fall())):(console.log("[PlayerMove] touch ground!",this.currentMovement),this.jumping=!1,this.fromLadder=!1,a.a.play("land"),this.currentMovement="idle",t.y=r.tile.y-t.getCurrentHeight(),void(this.vy=0)):(l||(t.x+=Math.ceil(this.vx)),t.y+=Math.ceil(this.vy),this.vy+=this.gravity,void 0):void console.log("not ready to jump",this.fromLadder)}},{key:"idle",value:function(){var e=this.sprite;this.vx=0,this.vy=0,e.stopAnimation()}},{key:"goDown",value:function(){var e=this.sprite;this.vx=0,this.vy=0,e.currentAnimName="goDown"+this.lookDirection,this.currentMovement=""}},{key:"faceWall",value:function(){var e=this.sprite;this.vx=0,this.vy=0,"faceWall"!==this.currentMovement&&(this.currentMovement="faceWall",e.advanceFrame("faceWall"),this.switchAbove=this.sprite.currentMap.getSwitchAboveMaster(),console.log("**** faceWall",this.switchAbove))}},{key:"climb",value:function(e){console.log("climbing");var t=this.sprite;this.fromLadder=!0,this.currentMovement="climb",this.vx=0,this.vy=e?-this.climbVY:this.climbVY,t.currentAnimName="climb",t.startAnimation(),t.x+=this.vx,t.y+=this.vy}},{key:"stopClimbing",value:function(){var e=this.sprite;this.vx=0,this.vy=0,e.stopAnimation()}},{key:"goUpOrClimb",value:function(e){var t=this.sprite,i=t.getHitBox(),n=e?0:24,s=!1,o=this.Input;return!0!==o.getKeyStatus(o.keys.LEFT)&&!0!==o.getKeyStatus(o.keys.RIGHT)&&(!0===e?t.currentMap.hitObjectTest(i.x+t.x,i.y+t.y+40,i.x+t.x-n,i.y2+t.y-50,u.a.TYPE.LADDER)&&(s=t.currentMap.hitObjectTest(i.x2+t.x+n,i.y+t.y+40,i.x2+t.x-n,i.y2+t.y-50,u.a.TYPE.LADDER)):s=t.currentMap.hitObjectTest(i.x+t.x+n,i.y+t.y+40,i.x2+t.x-n,i.y2+t.y-50,u.a.TYPE.LADDER),!1!==s?("climb"!==this.currentMovement&&(t.centerXOverTile(s),this.lookDirection=""),console.log("climbing, fromLadder",this.fromLadder,this.currentMovement),this.climb(1),!0):e?void 0:(this.faceWall(),!1))}},{key:"goDownOrClimb",value:function(){var e=this.sprite,t=e.getHitBox(),i=e.currentMap.hitObjectTest(t.x+e.x+24,t.y2+e.y+this.climbVY,t.x2+e.x-24,t.y2+e.y+this.climbVY,u.a.TYPE.LADDER);i?("climb"!==this.currentMovement&&e.centerXOverTile(i),console.log(t.x2+e.x-24,t.y2+e.y+this.climbVY),this.climb(0)):"climb"===this.currentMovement||"faceWall"===this.currentMovement?(console.log(t.x2+e.x-24,t.y2+e.y+this.climbVY),console.log("faceWall"),i=e.currentMap.hitObjectTest(t.x+e.x+24,t.y2+e.y+this.climbVY,t.x2+e.x-24,t.y2+e.y+this.climbVY,u.a.TYPE.LADDER),this.faceWall()):this.goDown()}},{key:"fall",value:function(){var e=4,t=this.sprite;for(this.jumping=!1;e>0;e--)if(this.fallTest(e)){this.vy=e;break}e>0?(this.vx=0,t.y+=this.vy,t.advanceFrame("fall"+this.lookDirection)):(this.fromLadder=!1,console.log("**land =>",this.fromLadder))}},{key:"fallTest",value:function(e){e=e||1;var t=this.sprite,i=t.getHitBox(),n=t.y+i.y2+e;return t.currentMap.fallTest(t.x+i.x,n)||t.currentMap.fallTest(t.x+i.x2,n)?("falling"==this.currentMovement&&(this.currentMovement=""),!1):(this.currentMovement="falling",!0)}}]),t}(r.a);t.a=h},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(3),a=i(2),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function(e){function t(e,i,o){n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,o));return r.elasticity=void 0!==o.elasticity?o.elasticity:.8,r.onEnd=o.onEnd||null,r.onGround=o.onGround||null,console.log("move initiated",e.vx,e.vy,r.startVy,e.gravity),r}return o(t,e),u(t,[{key:"onMove",value:function(e){var t=this.sprite,i=t.currentMap,n=t.x+t.vx,s=t.y+t.vy,o=t.getHitBox(),r=null;r=i.hitObjectTest(n+o.x,s+o.y2,n+o.x2,s+o.y2,a.a.TYPE.WALL),r?(this.onGround&&this.onGround(),this.resetY(),Math.abs(t.vy)<=t.gravity&&(t.moving=!1,this.onEnd&&this.onEnd())):(t.vy+=t.gravity,t.y+=t.vy)}},{key:"resetY",value:function(){this.sprite.vy=-this.sprite.vy*this.elasticity}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(3),a=i(2),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function(e){function t(e,i,o){n(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,o));return r.direction=o.direction||"right",r.direction.match("left")&&(e.vx=-e.vx),r.direction.match("top")&&(e.vy=-e.vy),r}return o(t,e),u(t,[{key:"onMove",value:function(e){var t=this.sprite,i=t.currentMap,n=t.x+t.vx,s=t.y+t.vy,o=t.getHitBox(),r=t.vx>0?o.x2:o.x;i.hitObjectTest(n+r,s+o.y,n+r,s+o.y2,a.a.TYPE.WALL)&&(t.vx=-t.vx,this.onVXChange&&this.onVXChange(t.vx)),t.x+=t.vx,t.y+=t.vy}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(4),a=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),u=function(e){function t(e){n(this,t);var i=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,"circle",e));return i.w=e.w||0,i.h=e.h||0,i.x=e.x||i.w/2,i.y=e.y||i.h/2,i.radius=e.radius||i.w/2,i.color=e.color||"red",i}return o(t,e),a(t,[{key:"draw",value:function(e,t){e.beginPath(),e.arc(this.x,this.y,this.radius,0,2*Math.PI),e.fillStyle=this.color,e.fill()}}]),t}(r.a);t.a=u},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=(i(12),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),o=function(){function e(t){n(this,e),this.score=t.score||0,this.alertnateScore=t.alternateScore||0,this.energy=t.energy||100,this.$dest=t.target,this.info="",this.inventory={},this.width=t.width||1024,this.height=t.height||64,Object.defineProperty(this,"score",{get:function(){return this.score},set:function(e){this.score=e}})}return s(e,[{key:"drawBackground",value:function(){}},{key:"draw",value:function(){this.drawBackground()}}]),e}();t.a=o},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var r=i(4),a=i(13),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),l=function(e){function t(e,i){n(this,t);var o=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i));return o.title=new a.a(e,{color:i.color||"black",text:i.title||"Menu Title"}),o.color=i.color||"white",o.selectedColor=i.selectedColor||"red",o.menuItems=[],o.selectedItem=i.selectedItem||0,o.selectCallbacks=[],o.hoverCallbacks=[],o.itemHeight=i.itemHeight||40,o.title.moveTo(o.x,o.y),o.addMenuItems(i.menuItems||[]),o}return o(t,e),u(t,[{key:"addMenuItem",value:function(e){var t=this.y+(this.menuItems.length+1)*this.itemHeight,i=new a.a("menuItem"+this.menuItems.length,e);i.moveTo(this.x,t),i.visible=!0===e.visible||!1,i.selectable=!0===e.selectable||!1,this.menuItems.push(i)}},{key:"addMenuItems",value:function(e){var t=this;console.log("addMenuItems",e),e.forEach(function(e,i){t.addMenuItem(e),e.active&&(t.selectedItem=i)})}},{key:"nextItem",value:function(){++this.selectedItem>=this.menuItems.length&&(this.selectedItem=0),this.selectedItem&&this.menuItems[this.selectedItem]&&!this.menuItems[this.selectedItem].selectable&&this.nextItem()}},{key:"getSelectedItemIndex",value:function(){return this.selectedItem}},{key:"getSelectedItem",value:function(){return this.menuItems[this.selectedItem]}},{key:"setText",value:function(e,t){this.menuItems[e]=t}},{key:"draw",value:function(e){var t=this;0!==this.angle&&(e.save(),e.rotate(this.angle)),this.title.draw(e),this.menuItems.forEach(function(i,n){n===t.selectedItem?i.color=t.selectedColor||"blue":i.color=t.color,i.draw(e)}),0!==this.angle&&e.restore()}}]),t}(r.a);t.a=l},function(e,t,i){"use strict";function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var s=i(6),o=(i(12),i(20),i(13),i(18)),r=(i(2),i(10)),a=i(0),u=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();window.scenes={};var l=function(){function e(t){n(this,e),t=t||{},console.log("[scene "+t.name||"] Init()",t),this.backgrounds=new Array(t.backgrounds||1),this.layers=new Array(t.layers||2),this.foregrounds=new Array(t.backgrounds||1),this.readyDef=null,this.resources=t.resources||null,this.pics={},this.map=null,this.loaded=!1,this.running=!1,this.backgroundImage=null,this.name=t.name||"Scene"+(new Date).getTime(),this.opacity=void 0!==t.opacity?t.opacity:1,this.hudScene=t.hudScene||null,this.time=null,this.playTime=null,window.scenes[this.name]=this,this._startCallbacks=[],this._fillArrays()}return u(e,[{key:"_prepareCanvas",value:function(){this.resources&&this.display.prepareCanvas(this.resources)}},{key:"_fillArrays",value:function(){for(var e=0;e<this.layers.length;++e)this.layers[e]=[];for(var t=0;t<this.backgrounds.length;++t)this.backgrounds[t]=[];for(var i=0;i<this.foregrounds.length;++i)this.foregrounds[i]=[]}},{key:"_getResourcesRef",value:function(){var e=this.resources;e&&e.forEach(function(e){e.elt=s.a.getResourceById(e.id)})}},{key:"loadResources",value:function(e,t){var i=this;return console.log("[scene "+this.name+"] loading Resources..."),this.loaded?console.log("[scene "+this.name+"]  seems like the scene has already been loaded: good!"):(console.log("[scene "+this.name+"]  seems like the scene needs to be loaded: goooo!"),this.readyDef=s.a.addResources(e),this.readyDef.then(function(){i.loaded=!0}),this.readyDef.then(this.cacheImages.bind(this)),this.readyDef.then(this.onLoad.bind(this)),s.a.loadResources("any",t)),this.readyDef}},{key:"load",value:function(){var e=this;if(console.log("[Scene "+this.name+"] load()"),this.hudScene&&!this.hudScene.loaded){var t=new a.a;return this.hudScene.load().then(function(){e.loadResources(e.resources).then(function(){t.resolve()})}),t.promise}return this.loadResources(this.resources)}},{key:"debug",value:function(){console.log("[scene "+this.name+"] debug() default scene debug does nothing!")}},{key:"onLoad",value:function(){this._fillArrays(),this._getResourcesRef(),this._prepareCanvas()}},{key:"onStart",value:function(e){this._startCallbacks.push(e.bind(this)),this.running&&e()}},{key:"cacheImages",value:function(){if(console.log("[scene "+this.name+"]  caching Images"),this.resources)try{for(var e=0,t=this.resources.length;e<t;e++){var i=this.resources[e].id;"image"===this.resources[e].type&&(this.pics[i]=s.a.getResourceById(i))}}catch(e){}}},{key:"setMap",value:function(e){e instanceof o.a?this.map=e:this.map=new o.a(e),window.currentMap=this.map}},{key:"addObject",value:function(e,t,i){console.log("[scene "+this.name+"] addObject",e,t,i);var n=t||"front",s=i||0,o=null;switch(n){case"back":o=this.backgrounds[s];break;case"fore":o=this.foregrounds[s];break;default:case"front":o=this.layers[s]}if(Array.isArray(e)){var r=!0,a=!1,u=void 0;try{for(var l,h=e[Symbol.iterator]();!(r=(l=h.next()).done);r=!0){var c=l.value;console.log("[scene "+this.name+"] pushing",c),o.push(c),"function"==typeof c.setImage&&c.setImage(this.pics[c.imageSrc]),c.setScene(this)}}catch(e){a=!0,u=e}finally{try{!r&&h.return&&h.return()}finally{if(a)throw u}}}else o.push(e),"function"==typeof e.setImage&&e.setImage(this.pics[e.imageSrc]),e.setScene(this)}},{key:"drawMap",value:function(e){this.map.isDirty&&(this.display.clearScreen(e),this.map.draw(e,!1))}},{key:"drawMapObjects",value:function(e){console.log("drawObjects"),this.map.drawObjects(e)}},{key:"drawSceneObjects",value:function(e){for(var t=0,i=this.layers.length;t<i;t++)for(var n=this.layers[t],s=0,o=n.length;s<o;s++){var r=n[s];r.draw(e)}}},{key:"moveSceneObjects",value:function(){for(var e=0,t=this.layers.length;e<t;e++)for(var i=this.layers[e],n=0,s=i.length;n<s;n++){var o=i[n];o.move()}}},{key:"setOpacity",value:function(e){this.opacity=e}},{key:"getOpacity",value:function(){return this.opacity}},{key:"setBackgroundImage",value:function(e){this.backgroundImage=e,e instanceof Image?new Dom(".main").css("backgroundImage","url("+e.src+")"):new Dom(".main").css("backgroundImage","url("+e+")")}},{key:"resume",value:function(){this.start(!0)}},{key:"start",value:function(e){this.loaded||console.warn("[Scene] start() attempt to start a scene that has not been loaded yet. Start failed."),this.running=!0,this.map&&(e?this.map.resume():this.map.reset(),this.map.isDirty=!0),this.backgrounds.length=0,this.layers.forEach(function(e){e.length=0}),this.display.clearAllScreens(),this.foregrounds.length=0,this.time=(new Date).getTime(),this.playTime=null,this.hudScene&&this.hudScene.start(),this._startCallbacks.forEach(function(e){e()})}},{key:"stop",value:function(){this.running=!1,this.hudScene&&this.hudScene.stop()}},{key:"pause",value:function(){this.running=!1,this.playTime=(new Date).getTime()-this.time,console.log("pausing, playTime = ",this.playTime/1e3),this.hudScene&&this.hudScene.pause()}},{key:"unpause",value:function(){this.running=!0,this.time=(new Date).getTime()-this.playTime,console.log("resuming, playTime = ",this.playTime/1e3),this.playTime=null,this.hudScene&&this.hudScene.unpause()}},{key:"getPlayTime",value:function(){return(this.playTime?this.playTime:(new Date).getTime()-this.time)/1e3}},{key:"run",value:function(){this.moveSceneObjects(),this.map&&(this.map.move(),this.map.checkCollisions())}},{key:"render",value:function(e){this.map&&(this.drawMap(e[0]),this.drawMapObjects(e[1])),this.drawSceneObjects(e[1])}},{key:"notify",value:function(e,t){r.a.notify(e,t)}},{key:"bindEvents",value:function(e){r.a.listen(e,this.onEvent.bind(this))}},{key:"onEvent",value:function(){}},{key:"setDisplay",value:function(e){this.display=e,this.hudScene&&this.hudScene.setDisplay(e)}},{key:"animate",value:function(e,t){return this.display.animate(e,t,this)}},{key:"removeObject",value:function(e){var t=this.layers[0],i=t.indexOf(e);i>-1&&t.splice(i,1)}}]),e}();t.a=l},function(e,t){!function(e){e.fpscounter=function(t){function i(e,t){return(!e[0]||t<e[0])&&(e[0]=t),(!e[1]||t>e[1])&&(e[1]=t),e}function n(){var e,t,o,r,a,h;P=!0,T=Date.now(),T>=C+S&&(e=Math.min(60,Math.round(1/(T-O)*1e3)),M.unshift(e),f.clearRect(0,0,u,l),M.length>j&&M.pop(),t=M.reduce(i,[]),o=t[0],r=t[1],a=r-o,f.fillStyle=k,f.beginPath(),f.moveTo(u,l),M.forEach(function(e,t){h=s(t,e,o,a),f.lineTo(h[0],h[1])}),f.lineTo(h[0],l),f.lineTo(u,l),f.fill(),f.stroke(),f.fillStyle="#fff",f.font=b,f.fillText(e,p,d),f.font=w,f.fillText(o,m,g),f.fillText(r,v,y),C=T),O=T,P&&(E=requestAnimationFrame(n))}function s(e,t,i,n){return[u-e,l-l*(t-i)/n]}function o(){O=Date.now(),M=[],C=O,n()}t=t||{};var r=e.fpscounter_options||{},a={remove_on_click:!1,width:100,height:50};Object.keys(a).forEach(function(e){t[e]=t[e]||r[e]||a[e]});var u=t.width,l=t.height,h=document.createElement("div");h.className="fpscounter",h.style.width=u+"px",h.style.height=l+"px";var c=document.createElement("canvas");c.className="fpscounter-canvas",c.width=u,c.height=l;var f=c.getContext("2d"),p=u/2-14,d=l/2+10,v=4,y=8,m=4,g=l-4,b="bold 30px Monospace",w="10px Monospace",k=f.createLinearGradient(0,0,0,l);k.addColorStop(0,"#001133"),k.addColorStop(1,"#112288");var x=f.createLinearGradient(0,0,0,l);x.addColorStop(0,"#2848d8"),x.addColorStop(1,"#3366ff"),f.lineWidth=1,f.strokeStyle=x;var _=document.createElement("style");_.textContent=".fpscounter { position: fixed; top: 0; right: 0; background-color: #000; color: #fff; font-size: 30px; font-family: monospace;z-index: 999999}",h.appendChild(c),document.body.appendChild(h),document.querySelector("head").appendChild(_);var O,T,C,S,E,P,M=[],j=u;S=100,h.addEventListener("click",function(){P=!P,P?o():(cancelAnimationFrame(E),t.remove_on_click&&document.body.removeChild(h))}),o()},!e.fpscounter_options||e.fpscounter_options.auto_start}(window),e.exports=fpscounter},function(e,t){function i(){throw new Error("setTimeout has not been defined")}function n(){throw new Error("clearTimeout has not been defined")}function s(e){if(h===setTimeout)return setTimeout(e,0);if((h===i||!h)&&setTimeout)return h=setTimeout,setTimeout(e,0);try{return h(e,0)}catch(t){try{return h.call(null,e,0)}catch(t){return h.call(this,e,0)}}}function o(e){if(c===clearTimeout)return clearTimeout(e);if((c===n||!c)&&clearTimeout)return c=clearTimeout,clearTimeout(e);try{return c(e)}catch(t){try{return c.call(null,e)}catch(t){return c.call(this,e)}}}function r(){v&&p&&(v=!1,p.length?d=p.concat(d):y=-1,d.length&&a())}function a(){if(!v){var e=s(r);v=!0;for(var t=d.length;t;){for(p=d,d=[];++y<t;)p&&p[y].run();y=-1,t=d.length}p=null,v=!1,o(e)}}function u(e,t){this.fun=e,this.array=t}function l(){}var h,c,f=e.exports={};!function(){try{h="function"==typeof setTimeout?setTimeout:i}catch(e){h=i}try{c="function"==typeof clearTimeout?clearTimeout:n}catch(e){c=n}}();var p,d=[],v=!1,y=-1;f.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)t[i-1]=arguments[i];d.push(new u(e,t)),1!==d.length||v||s(a)},u.prototype.run=function(){this.fun.apply(null,this.array)},f.title="browser",f.browser=!0,f.env={},f.argv=[],f.version="",f.versions={},f.on=l,f.addListener=l,f.once=l,f.off=l,f.removeListener=l,f.removeAllListeners=l,f.emit=l,f.prependListener=l,f.prependOnceListener=l,f.listeners=function(e){return[]},f.binding=function(e){throw new Error("process.binding is not supported")},f.cwd=function(){return"/"},f.chdir=function(e){throw new Error("process.chdir is not supported")},f.umask=function(){return 0}},function(e,t,i){var n,s;!function(i,o){n=[],void 0!==(s=function(){return i.Wad=o()}.apply(t,n))&&(e.exports=s)}(this,function(){!function(e){var t=function(e,t){var i=t||{},n=i.bufferLen||4096,s=i.numChannels||2;this.context=e.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,n,s,s);var o=new Worker(i.workerPath||"recorderWorker.js");o.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:s}});var r,a=!1;this.node.onaudioprocess=function(e){if(a){for(var t=[],i=0;i<s;i++)t.push(e.inputBuffer.getChannelData(i));o.postMessage({command:"record",buffer:t})}},this.configure=function(e){for(var t in e)e.hasOwnProperty(t)&&(i[t]=e[t])},this.record=function(){a=!0},this.stop=function(){a=!1},this.clear=function(){o.postMessage({command:"clear"})},this.getBuffer=function(e){r=e||i.callback,o.postMessage({command:"getBuffer"})},this.exportWAV=function(e,t){if(r=e||i.callback,t=t||i.type||"audio/wav",!r)throw new Error("Callback not set");o.postMessage({command:"exportWAV",type:t})},o.onmessage=function(e){var t=e.data;r(t)},e.connect(this.node),this.node.connect(this.context.destination)};t.forceDownload=function(t,i){var n=(e.URL||e.webkitURL).createObjectURL(t),s=e.document.createElement("a");s.href=n,s.download=i||"output.wav";var o=document.createEvent("Event");o.initEvent("click",!0,!0),s.dispatchEvent(o)},e.Recorder=t}(window),function(t){function i(){return n}function n(e){if(!(this instanceof n))return new n(e);if(t.AudioContext||(t.AudioContext=t.webkitAudioContext),e||(console.log("tuna.js: Missing audio context! Creating a new context for you."),e=t.AudioContext&&new t.AudioContext),!e)throw new Error("Tuna cannot initialize because this environment does not support web audio.");s(e),h=e,c=this}function s(e){function t(){var e=Array.prototype.shift.apply(arguments);return e=p.isPrototypeOf?p.isPrototypeOf(e)?e.input:e:e.input||e,arguments=Array.prototype.slice.call(arguments),arguments.unshift(e),s.apply(this,arguments),e}if(!0!==e.__connectified__){var i=e.createGain(),n=Object.getPrototypeOf(Object.getPrototypeOf(i)),s=n.connect;n.connect=t,e.__connectified__=!0}}function o(e){return Math.max(0,Math.round(100*Math.pow(2,e/6))/100)}function r(e,t){var i,n,s=0,o=0,r=0,a=0;return i=e.toExponential().match(/^.\.?(.*)e(.+)$/),s=parseInt(i[2],10)-(i[1]+"").length,i=t.toExponential().match(/^.\.?(.*)e(.+)$/),o=parseInt(i[2],10)-(i[1]+"").length,o>s&&(s=o),n=e%t,s<-100||s>20?(r=Math.round(Math.log(n)/Math.log(10)),a=Math.pow(10,r),(n/a).toFixed(r-s)*a):parseFloat(n.toFixed(-s))}function a(e){return 0===e?1:Math.abs(e)/e}function u(e){return(Math.exp(e)-Math.exp(-e))/(Math.exp(e)+Math.exp(-e))}function l(e,t){return void 0===e?t:e}var h,c,f=function(e,t){e.value=t},p=Object.create(null,{activate:{writable:!0,value:function(e){e?(this.input.disconnect(),this.input.connect(this.activateNode),this.activateCallback&&this.activateCallback(e)):(this.input.disconnect(),this.input.connect(this.output))}},bypass:{get:function(){return this._bypass},set:function(e){this._lastBypassValue!==e&&(this._bypass=e,this.activate(!e),this._lastBypassValue=e)}},connect:{value:function(e){this.output.connect(e)}},disconnect:{value:function(e){this.output.disconnect(e)}},connectInOrder:{value:function(e){for(var t=e.length-1;t--;){if(!e[t].connect)return console.error("AudioNode.connectInOrder: TypeError: Not an AudioNode.",e[t]);e[t+1].input?e[t].connect(e[t+1].input):e[t].connect(e[t+1])}}},getDefaults:{value:function(){var e={};for(var t in this.defaults)e[t]=this.defaults[t].value;return e}},automate:{value:function(e,t,i,n){var s,o=n?~~(n/1e3):h.currentTime,r=i?~~(i/1e3):0,a=this.defaults[e],u=this[e];u?a.automatable?(i?(s="linearRampToValueAtTime",u.cancelScheduledValues(o),u.setValueAtTime(u.value,o)):s="setValueAtTime",u[s](t,r+o)):u=t:console.error("Invalid Property for "+this.name)}}}),d="float",v="int";void 0!==e&&e.exports?e.exports=n:t.define("Tuna",i),n.prototype.Bitcrusher=function(e){e||(e=this.getDefaults()),this.bufferSize=e.bufferSize||this.defaults.bufferSize.value,this.input=h.createGain(),this.activateNode=h.createGain(),this.processor=h.createScriptProcessor(this.bufferSize,1,1),this.output=h.createGain(),this.activateNode.connect(this.processor),this.processor.connect(this.output);var t,i,n,s,o,r=0,a=0;this.processor.onaudioprocess=function(e){for(t=e.inputBuffer.getChannelData(0),i=e.outputBuffer.getChannelData(0),n=Math.pow(.5,this.bits),o=t.length,s=0;s<o;s++)r+=this.normfreq,r>=1&&(r-=1,a=n*Math.floor(t[s]/n+.5)),i[s]=a},this.bits=e.bits||this.defaults.bits.value,this.normfreq=l(e.normfreq,this.defaults.normfreq.value),this.bypass=e.bypass||!1},n.prototype.Bitcrusher.prototype=Object.create(p,{name:{value:"Bitcrusher"},defaults:{writable:!0,value:{bits:{value:4,min:1,max:16,automatable:!1,type:v},bufferSize:{value:4096,min:256,max:16384,automatable:!1,type:v},bypass:{value:!1,automatable:!1,type:"boolean"},normfreq:{value:.1,min:1e-4,max:1,automatable:!1,type:d}}},bits:{enumerable:!0,get:function(){return this.processor.bits},set:function(e){this.processor.bits=e}},normfreq:{enumerable:!0,get:function(){return this.processor.normfreq},set:function(e){this.processor.normfreq=e}}}),n.prototype.Cabinet=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.convolver=this.newConvolver(e.impulsePath||"../impulses/impulse_guitar.wav"),this.makeupNode=h.createGain(),this.output=h.createGain(),this.activateNode.connect(this.convolver.input),this.convolver.output.connect(this.makeupNode),this.makeupNode.connect(this.output),this.makeupGain=l(e.makeupGain,this.defaults.makeupGain),this.bypass=e.bypass||!1},n.prototype.Cabinet.prototype=Object.create(p,{name:{value:"Cabinet"},defaults:{writable:!0,value:{makeupGain:{value:1,min:0,max:20,automatable:!0,type:d},bypass:{value:!1,automatable:!1,type:"boolean"}}},makeupGain:{enumerable:!0,get:function(){return this.makeupNode.gain},set:function(e){this.makeupNode.gain.value=e}},newConvolver:{value:function(e){return new c.Convolver({impulse:e,dryLevel:0,wetLevel:1})}}}),n.prototype.Chorus=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.attenuator=this.activateNode=h.createGain(),this.splitter=h.createChannelSplitter(2),this.delayL=h.createDelay(),this.delayR=h.createDelay(),this.feedbackGainNodeLR=h.createGain(),this.feedbackGainNodeRL=h.createGain(),this.merger=h.createChannelMerger(2),this.output=h.createGain(),this.lfoL=new c.LFO({target:this.delayL.delayTime,callback:f}),this.lfoR=new c.LFO({target:this.delayR.delayTime,callback:f}),this.input.connect(this.attenuator),this.attenuator.connect(this.output),this.attenuator.connect(this.splitter),this.splitter.connect(this.delayL,0),this.splitter.connect(this.delayR,1),this.delayL.connect(this.feedbackGainNodeLR),this.delayR.connect(this.feedbackGainNodeRL),this.feedbackGainNodeLR.connect(this.delayR),this.feedbackGainNodeRL.connect(this.delayL),this.delayL.connect(this.merger,0,0),this.delayR.connect(this.merger,0,1),this.merger.connect(this.output),this.feedback=l(e.feedback,this.defaults.feedback.value),this.rate=l(e.rate,this.defaults.rate.value),this.delay=l(e.delay,this.defaults.delay.value),this.depth=l(e.depth,this.defaults.depth.value),this.lfoR.phase=Math.PI/2,this.attenuator.gain.value=.6934,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||!1},n.prototype.Chorus.prototype=Object.create(p,{name:{value:"Chorus"},defaults:{writable:!0,value:{feedback:{value:.4,min:0,max:.95,automatable:!1,type:d},delay:{value:.0045,min:0,max:1,automatable:!1,type:d},depth:{value:.7,min:0,max:1,automatable:!1,type:d},rate:{value:1.5,min:0,max:8,automatable:!1,type:d},bypass:{value:!1,automatable:!1,type:"boolean"}}},delay:{enumerable:!0,get:function(){return this._delay},set:function(e){this._delay=2*Math.pow(10,e)*2e-4,this.lfoL.offset=this._delay,this.lfoR.offset=this._delay,this._depth=this._depth}},depth:{enumerable:!0,get:function(){return this._depth},set:function(e){this._depth=e,this.lfoL.oscillation=this._depth*this._delay,this.lfoR.oscillation=this._depth*this._delay}},feedback:{enumerable:!0,get:function(){return this._feedback},set:function(e){this._feedback=e,this.feedbackGainNodeLR.gain.value=this._feedback,this.feedbackGainNodeRL.gain.value=this._feedback}},rate:{enumerable:!0,get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}}}),n.prototype.Compressor=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.compNode=this.activateNode=h.createDynamicsCompressor(),this.makeupNode=h.createGain(),this.output=h.createGain(),this.compNode.connect(this.makeupNode),this.makeupNode.connect(this.output),this.automakeup=l(e.automakeup,this.defaults.automakeup.value),this.makeupGain=e.makeupGain||this.defaults.makeupGain.value,this.threshold=l(e.threshold,this.defaults.threshold.value),this.release=e.release||this.defaults.release.value,this.attack=l(e.attack,this.defaults.attack.value),this.ratio=e.ratio||this.defaults.ratio.value,this.knee=l(e.knee,this.defaults.knee.value),this.bypass=e.bypass||!1},n.prototype.Compressor.prototype=Object.create(p,{name:{value:"Compressor"},defaults:{writable:!0,value:{threshold:{value:-20,min:-60,max:0,automatable:!0,type:d},release:{value:250,min:10,max:2e3,automatable:!0,type:d},makeupGain:{value:1,min:1,max:100,automatable:!0,type:d},attack:{value:1,min:0,max:1e3,automatable:!0,type:d},ratio:{value:4,min:1,max:50,automatable:!0,type:d},knee:{value:5,min:0,max:40,automatable:!0,type:d},automakeup:{value:!1,automatable:!1,type:"boolean"},bypass:{value:!1,automatable:!1,type:"boolean"}}},computeMakeup:{value:function(){var e=this.compNode;return-(e.threshold.value-e.threshold.value/e.ratio.value)/4}},automakeup:{enumerable:!0,get:function(){return this._automakeup},set:function(e){this._automakeup=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},threshold:{enumerable:!0,get:function(){return this.compNode.threshold},set:function(e){this.compNode.threshold.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},ratio:{enumerable:!0,get:function(){return this.compNode.ratio},set:function(e){this.compNode.ratio.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},knee:{enumerable:!0,get:function(){return this.compNode.knee},set:function(e){this.compNode.knee.value=e,this._automakeup&&(this.makeupGain=this.computeMakeup())}},attack:{enumerable:!0,get:function(){return this.compNode.attack},set:function(e){this.compNode.attack.value=e/1e3}},release:{enumerable:!0,get:function(){return this.compNode.release},set:function(e){this.compNode.release=e/1e3}},makeupGain:{enumerable:!0,get:function(){return this.makeupNode.gain},set:function(e){this.makeupNode.gain.value=o(e)}}}),n.prototype.Convolver=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.convolver=h.createConvolver(),this.dry=h.createGain(),this.filterLow=h.createBiquadFilter(),this.filterHigh=h.createBiquadFilter(),this.wet=h.createGain(),this.output=h.createGain(),this.activateNode.connect(this.filterLow),this.activateNode.connect(this.dry),this.filterLow.connect(this.filterHigh),this.filterHigh.connect(this.convolver),this.convolver.connect(this.wet),this.wet.connect(this.output),this.dry.connect(this.output),this.dryLevel=l(e.dryLevel,this.defaults.dryLevel.value),this.wetLevel=l(e.wetLevel,this.defaults.wetLevel.value),this.highCut=e.highCut||this.defaults.highCut.value,this.buffer=e.impulse||"../impulses/ir_rev_short.wav",this.lowCut=e.lowCut||this.defaults.lowCut.value,this.level=l(e.level,this.defaults.level.value),this.filterHigh.type="lowpass",this.filterLow.type="highpass",this.bypass=e.bypass||!1},n.prototype.Convolver.prototype=Object.create(p,{name:{value:"Convolver"},defaults:{writable:!0,value:{highCut:{value:22050,min:20,max:22050,automatable:!0,type:d},lowCut:{value:20,min:20,max:22050,automatable:!0,type:d},dryLevel:{value:1,min:0,max:1,automatable:!0,type:d},wetLevel:{value:1,min:0,max:1,automatable:!0,type:d},level:{value:1,min:0,max:1,automatable:!0,type:d}}},lowCut:{get:function(){return this.filterLow.frequency},set:function(e){this.filterLow.frequency.value=e}},highCut:{get:function(){return this.filterHigh.frequency},set:function(e){this.filterHigh.frequency.value=e}},level:{get:function(){return this.output.gain},set:function(e){this.output.gain.value=e}},dryLevel:{get:function(){return this.dry.gain},set:function(e){this.dry.gain.value=e}},wetLevel:{get:function(){return this.wet.gain},set:function(e){this.wet.gain.value=e}},buffer:{enumerable:!1,get:function(){return this.convolver.buffer},set:function(e){var t=this.convolver,i=new XMLHttpRequest;if(!e)return void console.log("Tuna.Convolver.setBuffer: Missing impulse path!");i.open("GET",e,!0),i.responseType="arraybuffer",i.onreadystatechange=function(){4===i.readyState&&(i.status<300&&i.status>199||302===i.status)&&h.decodeAudioData(i.response,function(e){t.buffer=e},function(e){e&&console.log("Tuna.Convolver.setBuffer: Error decoding data"+e)})},i.send(null)}}}),n.prototype.Delay=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.dry=h.createGain(),this.wet=h.createGain(),this.filter=h.createBiquadFilter(),this.delay=h.createDelay(),this.feedbackNode=h.createGain(),this.output=h.createGain(),this.activateNode.connect(this.delay),this.activateNode.connect(this.dry),this.delay.connect(this.filter),this.filter.connect(this.feedbackNode),this.feedbackNode.connect(this.delay),this.feedbackNode.connect(this.wet),this.wet.connect(this.output),this.dry.connect(this.output),this.delayTime=e.delayTime||this.defaults.delayTime.value,this.feedback=l(e.feedback,this.defaults.feedback.value),this.wetLevel=l(e.wetLevel,this.defaults.wetLevel.value),this.dryLevel=l(e.dryLevel,this.defaults.dryLevel.value),this.cutoff=e.cutoff||this.defaults.cutoff.value,this.filter.type="lowpass",this.bypass=e.bypass||!1},n.prototype.Delay.prototype=Object.create(p,{name:{value:"Delay"},defaults:{writable:!0,value:{delayTime:{value:100,min:20,max:1e3,automatable:!1,type:d},feedback:{value:.45,min:0,max:.9,automatable:!0,type:d},cutoff:{value:2e4,min:20,max:2e4,automatable:!0,type:d},wetLevel:{value:.5,min:0,max:1,automatable:!0,type:d},dryLevel:{value:1,min:0,max:1,automatable:!0,type:d}}},delayTime:{enumerable:!0,get:function(){return this.delay.delayTime},set:function(e){this.delay.delayTime.value=e/1e3}},wetLevel:{enumerable:!0,get:function(){return this.wet.gain},set:function(e){this.wet.gain.value=e}},dryLevel:{enumerable:!0,get:function(){return this.dry.gain},set:function(e){this.dry.gain.value=e}},feedback:{enumerable:!0,get:function(){return this.feedbackNode.gain},set:function(e){this.feedbackNode.gain.value=e}},cutoff:{enumerable:!0,get:function(){return this.filter.frequency},set:function(e){this.filter.frequency.value=e}}}),n.prototype.Filter=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.filter=h.createBiquadFilter(),this.output=h.createGain(),this.activateNode.connect(this.filter),this.filter.connect(this.output),this.frequency=e.frequency||this.defaults.frequency.value,this.Q=e.resonance||this.defaults.Q.value,this.filterType=l(e.filterType,this.defaults.filterType.value),this.gain=l(e.gain,this.defaults.gain.value),this.bypass=e.bypass||!1},n.prototype.Filter.prototype=Object.create(p,{name:{value:"Filter"},defaults:{writable:!0,value:{frequency:{value:800,min:20,max:22050,automatable:!0,type:d},Q:{value:1,min:.001,max:100,automatable:!0,type:d},gain:{value:0,min:-40,max:40,automatable:!0,type:d},bypass:{value:!1,automatable:!1,type:"boolean"},filterType:{value:"lowpass",automatable:!1,type:"string"}}},filterType:{enumerable:!0,get:function(){return this.filter.type},set:function(e){this.filter.type=e}},Q:{enumerable:!0,get:function(){return this.filter.Q},set:function(e){this.filter.Q.value=e}},gain:{enumerable:!0,get:function(){return this.filter.gain},set:function(e){this.filter.gain.value=e}},frequency:{enumerable:!0,get:function(){return this.filter.frequency},set:function(e){this.filter.frequency.value=e}}}),n.prototype.MoogFilter=function(e){e||(e=this.getDefaults()),this.bufferSize=e.bufferSize||this.defaults.bufferSize.value,this.input=h.createGain(),this.activateNode=h.createGain(),this.processor=h.createScriptProcessor(this.bufferSize,1,1),this.output=h.createGain(),this.activateNode.connect(this.processor),this.processor.connect(this.output);var t,i,n,s,o,r,a,u;t=i=n=s=o=r=a=u=0;var c,f,p,d,v,y;this.processor.onaudioprocess=function(e){for(c=e.inputBuffer.getChannelData(0),f=e.outputBuffer.getChannelData(0),p=1.16*this.cutoff,inputFactor=p*p*.35013*(p*p),d=this.resonance*(1-.15*p*p),y=c.length,v=0;v<y;v++)c[v]-=u*d,c[v]*=inputFactor,o=c[v]+.3*t+(1-p)*o,t=c[v],r=o+.3*i+(1-p)*r,i=o,a=r+.3*n+(1-p)*a,n=r,u=a+.3*s+(1-p)*u,s=a,f[v]=u},this.cutoff=l(e.cutoff,this.defaults.cutoff.value),this.resonance=l(e.resonance,this.defaults.resonance.value),this.bypass=e.bypass||!1},n.prototype.MoogFilter.prototype=Object.create(p,{name:{value:"MoogFilter"},defaults:{writable:!0,value:{bufferSize:{value:4096,min:256,max:16384,automatable:!1,type:v},bypass:{value:!1,automatable:!1,type:"boolean"},cutoff:{value:.065,min:1e-4,max:1,automatable:!1,type:d},resonance:{value:3.5,min:0,max:4,automatable:!1,type:d}}},cutoff:{enumerable:!0,get:function(){return this.processor.cutoff},set:function(e){this.processor.cutoff=e}},resonance:{enumerable:!0,get:function(){return this.processor.resonance},set:function(e){this.processor.resonance=e}}}),n.prototype.Overdrive=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.inputDrive=h.createGain(),this.waveshaper=h.createWaveShaper(),this.outputDrive=h.createGain(),this.output=h.createGain(),this.activateNode.connect(this.inputDrive),this.inputDrive.connect(this.waveshaper),this.waveshaper.connect(this.outputDrive),this.outputDrive.connect(this.output),this.ws_table=new Float32Array(this.k_nSamples),this.drive=l(e.drive,this.defaults.drive.value),this.outputGain=l(e.outputGain,this.defaults.outputGain.value),this.curveAmount=l(e.curveAmount,this.defaults.curveAmount.value),this.algorithmIndex=l(e.algorithmIndex,this.defaults.algorithmIndex.value),this.bypass=e.bypass||!1},n.prototype.Overdrive.prototype=Object.create(p,{name:{value:"Overdrive"},defaults:{writable:!0,value:{drive:{value:1,min:0,max:1,automatable:!0,type:d,scaled:!0},outputGain:{value:1,min:0,max:1,automatable:!0,type:d,scaled:!0},curveAmount:{value:.725,min:0,max:1,automatable:!1,type:d},algorithmIndex:{value:0,min:0,max:5,automatable:!1,type:v}}},k_nSamples:{value:8192},drive:{get:function(){return this.inputDrive.gain},set:function(e){this._drive=e}},curveAmount:{get:function(){return this._curveAmount},set:function(e){this._curveAmount=e,void 0===this._algorithmIndex&&(this._algorithmIndex=0),this.waveshaperAlgorithms[this._algorithmIndex](this._curveAmount,this.k_nSamples,this.ws_table),this.waveshaper.curve=this.ws_table}},outputGain:{get:function(){return this.outputDrive.gain},set:function(e){this._outputGain=o(e)}},algorithmIndex:{get:function(){return this._algorithmIndex},set:function(e){this._algorithmIndex=e,this.curveAmount=this._curveAmount}},waveshaperAlgorithms:{value:[function(e,t,i){e=Math.min(e,.9999);var n,s,o=2*e/(1-e);for(n=0;n<t;n++)s=2*n/t-1,i[n]=(1+o)*s/(1+o*Math.abs(s))},function(e,t,i){var n,s,o;for(n=0;n<t;n++)s=2*n/t-1,o=(.5*Math.pow(s+1.4,2)-1)*o>=0?5.8:1.2,i[n]=u(o)},function(e,t,i){var n,s,o,r=1-e;for(n=0;n<t;n++)s=2*n/t-1,o=s<0?-Math.pow(Math.abs(s),r+.04):Math.pow(s,r),i[n]=u(2*o)},function(e,t,i){var n,s,o,r,u=1-e>.99?.99:1-e;for(n=0;n<t;n++)s=2*n/t-1,r=Math.abs(s),r<u?o=r:r>u?o=u+(r-u)/(1+Math.pow((r-u)/(1-u),2)):r>1&&(o=r),i[n]=a(s)*o*(1/((u+1)/2))},function(e,t,i){var n,s;for(n=0;n<t;n++)s=2*n/t-1,i[n]=s<-.08905?-.75*(1-Math.pow(1-(Math.abs(s)-.032857),12)+1/3*(Math.abs(s)-.032847))+.01:s>=-.08905&&s<.320018?s*s*-6.153+3.9375*s:.630035},function(e,t,i){var n,s,o=2+Math.round(14*e),r=Math.round(Math.pow(2,o-1));for(n=0;n<t;n++)s=2*n/t-1,i[n]=Math.round(s*r)/r}]}}),n.prototype.Phaser=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.splitter=this.activateNode=h.createChannelSplitter(2),this.filtersL=[],this.filtersR=[],this.feedbackGainNodeL=h.createGain(),this.feedbackGainNodeR=h.createGain(),this.merger=h.createChannelMerger(2),this.filteredSignal=h.createGain(),this.output=h.createGain(),this.lfoL=new c.LFO({target:this.filtersL,callback:this.callback}),this.lfoR=new c.LFO({target:this.filtersR,callback:this.callback});for(var t=this.stage;t--;)this.filtersL[t]=h.createBiquadFilter(),this.filtersR[t]=h.createBiquadFilter(),this.filtersL[t].type="allpass",this.filtersR[t].type="allpass";this.input.connect(this.splitter),this.input.connect(this.output),this.splitter.connect(this.filtersL[0],0,0),this.splitter.connect(this.filtersR[0],1,0),this.connectInOrder(this.filtersL),this.connectInOrder(this.filtersR),this.filtersL[this.stage-1].connect(this.feedbackGainNodeL),this.filtersL[this.stage-1].connect(this.merger,0,0),this.filtersR[this.stage-1].connect(this.feedbackGainNodeR),this.filtersR[this.stage-1].connect(this.merger,0,1),this.feedbackGainNodeL.connect(this.filtersL[0]),this.feedbackGainNodeR.connect(this.filtersR[0]),this.merger.connect(this.output),this.rate=l(e.rate,this.defaults.rate.value),this.baseModulationFrequency=e.baseModulationFrequency||this.defaults.baseModulationFrequency.value,this.depth=l(e.depth,this.defaults.depth.value),this.feedback=l(e.feedback,this.defaults.feedback.value),this.stereoPhase=l(e.stereoPhase,this.defaults.stereoPhase.value),this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||!1},n.prototype.Phaser.prototype=Object.create(p,{name:{value:"Phaser"},stage:{value:4},defaults:{writable:!0,value:{rate:{value:.1,min:0,max:8,automatable:!1,type:d},depth:{value:.6,min:0,max:1,automatable:!1,type:d},feedback:{value:.7,min:0,max:1,automatable:!1,type:d},stereoPhase:{value:40,min:0,max:180,automatable:!1,type:d},baseModulationFrequency:{value:700,min:500,max:1500,automatable:!1,type:d}}},callback:{value:function(e,t){for(var i=0;i<4;i++)e[i].frequency.value=t}},depth:{get:function(){return this._depth},set:function(e){this._depth=e,this.lfoL.oscillation=this._baseModulationFrequency*this._depth,this.lfoR.oscillation=this._baseModulationFrequency*this._depth}},rate:{get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}},baseModulationFrequency:{enumerable:!0,get:function(){return this._baseModulationFrequency},set:function(e){this._baseModulationFrequency=e,this.lfoL.offset=this._baseModulationFrequency,this.lfoR.offset=this._baseModulationFrequency,this._depth=this._depth}},feedback:{get:function(){return this._feedback},set:function(e){this._feedback=e,this.feedbackGainNodeL.gain.value=this._feedback,this.feedbackGainNodeR.gain.value=this._feedback}},stereoPhase:{get:function(){return this._stereoPhase},set:function(e){this._stereoPhase=e;var t=this.lfoL._phase+this._stereoPhase*Math.PI/180;t=r(t,2*Math.PI),this.lfoR._phase=t}}}),n.prototype.PingPongDelay=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.wetLevel=h.createGain(),this.stereoToMonoMix=h.createGain(),this.feedbackLevel=h.createGain(),this.output=h.createGain(),this.delayLeft=h.createDelay(),this.delayRight=h.createDelay(),this.activateNode=h.createGain(),this.splitter=h.createChannelSplitter(2),this.merger=h.createChannelMerger(2),this.activateNode.connect(this.splitter),this.splitter.connect(this.stereoToMonoMix,0,0),this.splitter.connect(this.stereoToMonoMix,1,0),this.stereoToMonoMix.gain.value=.5,this.stereoToMonoMix.connect(this.wetLevel),this.wetLevel.connect(this.delayLeft),this.feedbackLevel.connect(this.delayLeft),this.delayLeft.connect(this.delayRight),this.delayRight.connect(this.feedbackLevel),this.delayLeft.connect(this.merger,0,0),this.delayRight.connect(this.merger,0,1),this.merger.connect(this.output),this.activateNode.connect(this.output),this.delayTimeLeft=void 0!==e.delayTimeLeft?e.delayTimeLeft:this.defaults.delayTimeLeft.value,this.delayTimeRight=void 0!==e.delayTimeRight?e.delayTimeRight:this.defaults.delayTimeRight.value,this.feedbackLevel.gain.value=void 0!==e.feedback?e.feedback:this.defaults.feedback.value,this.wetLevel.gain.value=void 0!==e.wetLevel?e.wetLevel:this.defaults.wetLevel.value,this.bypass=e.bypass||!1},n.prototype.PingPongDelay.prototype=Object.create(p,{name:{value:"PingPongDelay"},delayTimeLeft:{enumerable:!0,get:function(){return this._delayTimeLeft},set:function(e){this._delayTimeLeft=e,this.delayLeft.delayTime.value=e/1e3}},delayTimeRight:{enumerable:!0,get:function(){return this._delayTimeRight},set:function(e){this._delayTimeRight=e,this.delayRight.delayTime.value=e/1e3}},defaults:{writable:!0,value:{delayTimeLeft:{value:200,min:1,max:1e4,automatable:!1,type:v},delayTimeRight:{value:400,min:1,max:1e4,automatable:!1,type:v},feedback:{value:.3,min:0,max:1,automatable:!1,type:d},wetLevel:{value:.5,min:0,max:1,automatable:!1,type:d}}}}),n.prototype.Tremolo=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.splitter=this.activateNode=h.createChannelSplitter(2),this.amplitudeL=h.createGain(),this.amplitudeR=h.createGain(),this.merger=h.createChannelMerger(2),this.output=h.createGain(),this.lfoL=new c.LFO({target:this.amplitudeL.gain,callback:f}),this.lfoR=new c.LFO({target:this.amplitudeR.gain,callback:f}),this.input.connect(this.splitter),this.splitter.connect(this.amplitudeL,0),this.splitter.connect(this.amplitudeR,1),this.amplitudeL.connect(this.merger,0,0),this.amplitudeR.connect(this.merger,0,1),this.merger.connect(this.output),this.rate=e.rate||this.defaults.rate.value,this.intensity=l(e.intensity,this.defaults.intensity.value),this.stereoPhase=l(e.stereoPhase,this.defaults.stereoPhase.value),this.lfoL.offset=1-this.intensity/2,this.lfoR.offset=1-this.intensity/2,this.lfoL.phase=this.stereoPhase*Math.PI/180,this.lfoL.activate(!0),this.lfoR.activate(!0),this.bypass=e.bypass||!1},n.prototype.Tremolo.prototype=Object.create(p,{name:{value:"Tremolo"},defaults:{writable:!0,value:{intensity:{value:.3,min:0,max:1,automatable:!1,type:d},stereoPhase:{value:0,min:0,max:180,automatable:!1,type:d},rate:{value:5,min:.1,max:11,automatable:!1,type:d}}},intensity:{enumerable:!0,get:function(){return this._intensity},set:function(e){this._intensity=e,this.lfoL.offset=1-this._intensity/2,this.lfoR.offset=1-this._intensity/2,this.lfoL.oscillation=this._intensity,this.lfoR.oscillation=this._intensity}},rate:{enumerable:!0,get:function(){return this._rate},set:function(e){this._rate=e,this.lfoL.frequency=this._rate,this.lfoR.frequency=this._rate}},stereoPhase:{enumerable:!0,get:function(){return this._rate},set:function(e){this._stereoPhase=e;var t=this.lfoL._phase+this._stereoPhase*Math.PI/180;t=r(t,2*Math.PI),this.lfoR.phase=t}}}),n.prototype.WahWah=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.activateNode=h.createGain(),this.envelopeFollower=new c.EnvelopeFollower({target:this,callback:function(e,t){e.sweep=t}}),this.filterBp=h.createBiquadFilter(),this.filterPeaking=h.createBiquadFilter(),this.output=h.createGain(),this.activateNode.connect(this.filterBp),this.filterBp.connect(this.filterPeaking),this.filterPeaking.connect(this.output),this.init(),this.automode=l(e.enableAutoMode,this.defaults.automode.value),this.resonance=e.resonance||this.defaults.resonance.value,this.sensitivity=l(e.sensitivity,this.defaults.sensitivity.value),this.baseFrequency=l(e.baseFrequency,this.defaults.baseFrequency.value),this.excursionOctaves=e.excursionOctaves||this.defaults.excursionOctaves.value,this.sweep=l(e.sweep,this.defaults.sweep.value),this.activateNode.gain.value=2,this.envelopeFollower.activate(!0),this.bypass=e.bypass||!1},n.prototype.WahWah.prototype=Object.create(p,{name:{value:"WahWah"},defaults:{writable:!0,value:{automode:{value:!0,automatable:!1,type:"boolean"},baseFrequency:{value:.5,min:0,max:1,automatable:!1,type:d},excursionOctaves:{value:2,min:1,max:6,automatable:!1,type:d},sweep:{value:.2,min:0,max:1,automatable:!1,type:d},resonance:{value:10,min:1,max:100,automatable:!1,type:d},sensitivity:{value:.5,min:-1,max:1,automatable:!1,type:d}}},activateCallback:{value:function(e){this.automode=e}},automode:{get:function(){return this._automode},set:function(e){this._automode=e,e?(this.activateNode.connect(this.envelopeFollower.input),this.envelopeFollower.activate(!0)):(this.envelopeFollower.activate(!1),this.activateNode.disconnect(),this.activateNode.connect(this.filterBp))}},filterFreqTimeout:{value:0},setFilterFreq:{value:function(){try{this.filterBp.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep,this.filterPeaking.frequency.value=this._baseFrequency+this._excursionFrequency*this._sweep}catch(e){clearTimeout(this.filterFreqTimeout),this.filterFreqTimeout=setTimeout(function(){this.setFilterFreq()}.bind(this),0)}}},sweep:{enumerable:!0,get:function(){return this._sweep.value},set:function(e){this._sweep=Math.pow(e>1?1:e<0?0:e,this._sensitivity),this.setFilterFreq()}},baseFrequency:{enumerable:!0,get:function(){return this._baseFrequency},set:function(e){this._baseFrequency=50*Math.pow(10,2*e),this._excursionFrequency=Math.min(h.sampleRate/2,this.baseFrequency*Math.pow(2,this._excursionOctaves)),this.setFilterFreq()}},excursionOctaves:{enumerable:!0,get:function(){return this._excursionOctaves},set:function(e){this._excursionOctaves=e,this._excursionFrequency=Math.min(h.sampleRate/2,this.baseFrequency*Math.pow(2,this._excursionOctaves)),this.setFilterFreq()}},sensitivity:{enumerable:!0,get:function(){return this._sensitivity},set:function(e){this._sensitivity=Math.pow(10,e)}},resonance:{enumerable:!0,get:function(){return this._resonance},set:function(e){this._resonance=e,this.filterPeaking.Q=this._resonance}},init:{value:function(){this.output.gain.value=1,this.filterPeaking.type="peaking",this.filterBp.type="bandpass",this.filterPeaking.frequency.value=100,this.filterPeaking.gain.value=20,this.filterPeaking.Q.value=5,this.filterBp.frequency.value=100,this.filterBp.Q.value=1}}}),n.prototype.EnvelopeFollower=function(e){e||(e=this.getDefaults()),this.input=h.createGain(),this.jsNode=this.output=h.createScriptProcessor(this.buffersize,1,1),this.input.connect(this.output),this.attackTime=l(e.attackTime,this.defaults.attackTime.value),this.releaseTime=l(e.releaseTime,this.defaults.releaseTime.value),this._envelope=0,this.target=e.target||{},this.callback=e.callback||function(){}},n.prototype.EnvelopeFollower.prototype=Object.create(p,{name:{value:"EnvelopeFollower"},defaults:{value:{attackTime:{value:.003,min:0,max:.5,automatable:!1,type:d},releaseTime:{value:.5,min:0,max:.5,automatable:!1,type:d}}},buffersize:{value:256},envelope:{value:0},sampleRate:{value:44100},attackTime:{enumerable:!0,get:function(){return this._attackTime},set:function(e){this._attackTime=e,this._attackC=Math.exp(-1/this._attackTime*this.sampleRate/this.buffersize)}},releaseTime:{enumerable:!0,get:function(){return this._releaseTime},set:function(e){this._releaseTime=e,this._releaseC=Math.exp(-1/this._releaseTime*this.sampleRate/this.buffersize)}},callback:{get:function(){return this._callback},set:function(e){"function"==typeof e?this._callback=e:console.error("tuna.js: "+this.name+": Callback must be a function!")}},target:{get:function(){return this._target},set:function(e){this._target=e}},activate:{value:function(e){this.activated=e,e?(this.jsNode.connect(h.destination),this.jsNode.onaudioprocess=this.returnCompute(this)):(this.jsNode.disconnect(),this.jsNode.onaudioprocess=null)}},returnCompute:{value:function(e){return function(t){e.compute(t)}}},compute:{value:function(e){var t,i,n,s,o=e.inputBuffer.getChannelData(0).length,r=e.inputBuffer.numberOfChannels;if(i=n=s=0,r>1)for(s=0;s<o;++s)for(;i<r;++i)t=e.inputBuffer.getChannelData(i)[s],n+=t*t/r;else for(s=0;s<o;++s)t=e.inputBuffer.getChannelData(0)[s],n+=t*t;n=Math.sqrt(n),this._envelope<n?(this._envelope*=this._attackC,this._envelope+=(1-this._attackC)*n):(this._envelope*=this._releaseC,this._envelope+=(1-this._releaseC)*n),this._callback(this._target,this._envelope)}}}),n.prototype.LFO=function(e){this.output=h.createScriptProcessor(256,1,1),this.activateNode=h.destination,this.frequency=l(e.frequency,this.defaults.frequency.value),this.offset=l(e.offset,this.defaults.offset.value),this.oscillation=l(e.oscillation,this.defaults.oscillation.value),this.phase=l(e.phase,this.defaults.phase.value),this.target=e.target||{},this.output.onaudioprocess=this.callback(e.callback||function(){}),this.bypass=e.bypass||!1},n.prototype.LFO.prototype=Object.create(p,{name:{value:"LFO"},bufferSize:{value:256},sampleRate:{value:44100},defaults:{value:{frequency:{value:1,min:0,max:20,automatable:!1,type:d},offset:{value:.85,min:0,max:22049,automatable:!1,type:d},oscillation:{value:.3,min:-22050,max:22050,automatable:!1,type:d},phase:{value:0,min:0,max:2*Math.PI,automatable:!1,type:d}}},frequency:{get:function(){return this._frequency},set:function(e){this._frequency=e,this._phaseInc=2*Math.PI*this._frequency*this.bufferSize/this.sampleRate}},offset:{get:function(){return this._offset},set:function(e){this._offset=e}},oscillation:{get:function(){return this._oscillation},set:function(e){this._oscillation=e}},phase:{get:function(){return this._phase},set:function(e){this._phase=e}},target:{get:function(){return this._target},set:function(e){this._target=e}},activate:{value:function(e){e?this.output.connect(h.destination):this.output.disconnect(h.destination)}},callback:{value:function(e){var t=this;return function(){t._phase+=t._phaseInc,t._phase>2*Math.PI&&(t._phase=0),e(t._target,t._offset+t._oscillation*Math.sin(t._phase))}}}}),n.toString=n.prototype.toString=function(){return"Please visit https://github.com/Theodeus/tuna/wiki for instructions on how to use Tuna.js"}}(this);var t=window.AudioContext||window.webkitAudioContext,i=new t;({UNSUPPORT:!1,SUPPORT_STANDARD_VERSION:1,SUPPORT_DEPRECATED_VERSION:2,isGetUserMediaSupported:function(e){return e.navigator.mediaDevices.getUserMedia?this.SUPPORT_STANDARD_VERSION:e.navigator.getUserMedia?this.SUPPORT_DEPRECATED_VERSION:this.UNSUPPORT},initialize:function(e){e.navigator.mediaDevices=e.navigator.mediaDevices||{},e.navigator.getUserMedia=e.navigator.getUserMedia||e.navigator.webkitGetUserMedia||e.navigator.mozGetUserMedia;var t=this.isGetUserMediaSupported(e);t!=this.UNSUPPORT&&(e.getUserMedia=t==this.SUPPORT_STANDARD_VERSION?e.navigator.mediaDevices.getUserMedia.bind(e.navigator.mediaDevices):function(t){return new Promise(function(i,n){e.navigator.getUserMedia(t,i,n)})})}}).initialize(window),window.getUserMedia?console.log("Your browser supports getUserMedia."):console.log("Your browser does not support getUserMedia.");var n=function(){function e(e,t){var i=-1,n=0,s=0,o=!1;if(e.length<1996)return-1;for(var r=0;r<1e3;r++){var a=(e[r]-128)/128;s+=a*a}if((s=Math.sqrt(s/1e3))<.01)return-1;for(var u=1,l=4;l<=1e3;l++){for(var h=0,r=0;r<1e3;r++)h+=Math.abs((e[r]-128)/128-(e[r+l]-128)/128);if((h=1-h/1e3)>.9&&h>u)o=!0;else if(o)return t/i;u=h,h>n&&(n=h,i=l)}return n>.01?t/i:-1}var t=function(){Math.seed=6,Math.seededRandom=function(e,t){return e=e||1,t=t||0,Math.seed=(9301*Math.seed+49297)%233280,t+Math.seed/233280*(e-t)};for(var e=2*i.sampleRate,t=i.createBuffer(1,e,i.sampleRate),n=t.getChannelData(0),s=0;s<e;s++)n[s]=2*Math.seededRandom()-1;return t}(),n=function(e){return"[object Array]"===Object.prototype.toString.call(e)},s=function(e,t){e.env={attack:t.env?j(t.env.attack,1):0,decay:t.env?j(t.env.decay,0):0,sustain:t.env?j(t.env.sustain,1):1,hold:t.env?j(t.env.hold,3.14159):3.14159,release:t.env?j(t.env.release,0):0},e.defaultEnv={attack:t.env?j(t.env.attack,1):0,decay:t.env?j(t.env.decay,0):0,sustain:t.env?j(t.env.sustain,1):1,hold:t.env?j(t.env.hold,3.14159):3.14159,release:t.env?j(t.env.release,0):0}},o=function(e,t){t.filter?n(t.filter)?e.filter=t.filter.map(function(e){return{type:e.type||"lowpass",frequency:e.frequency||600,q:e.q||1,env:e.env||null}}):e.filter=[{type:t.filter.type||"lowpass",frequency:t.filter.frequency||600,q:t.filter.q||1,env:t.filter.env||null}]:t.filter=null},r=function(e,t){var n=new XMLHttpRequest;n.open("GET",e.source,!0),n.responseType="arraybuffer",e.playable--,n.onload=function(){i.decodeAudioData(n.response,function(i){e.decodedBuffer=i,3.14159===e.env.hold&&(e.env.hold=e.decodedBuffer.duration+1),t&&t(e),e.playable++,e.playOnLoad&&e.play(e.playOnLoadArg)})},n.send()},a=function(e,t){t.vibrato?e.vibrato={shape:j(t.vibrato.shape,"sine"),speed:j(t.vibrato.speed,1),magnitude:j(t.vibrato.magnitude,5),attack:j(t.vibrato.attack,0)}:e.vibrato=null},u=function(e,t){t.tremolo?e.tremolo={shape:j(t.tremolo.shape,"sine"),speed:j(t.tremolo.speed,1),magnitude:j(t.tremolo.magnitude,5),attack:j(t.tremolo.attack,1)}:e.tremolo=null},l=function(e,t){if(t.reverb){e.reverb={wet:j(t.reverb.wet,1)};var n=t.reverb.impulse||d.defaultImpulse,s=new XMLHttpRequest;s.open("GET",n,!0),s.responseType="arraybuffer",e.playable--,s.onload=function(){i.decodeAudioData(s.response,function(i){e.reverb.buffer=i,e.playable++,e.playOnLoad&&e.play(e.playOnLoadArg),e instanceof d.Poly&&e.setUp(t),"mic"===e.source&&e.reverb&&e.reverb.buffer&&e.reverb.node&&!e.reverb.node.buffer&&(e.reverb.node.convolver.buffer=e.reverb.buffer)})},s.send()}else e.reverb=null},h=function(e,t){"panning"in t?(e.panning={location:t.panning},"number"==typeof t.panning?e.panning.type="stereo":(e.panning.type="3d",e.panning.panningModel=t.panningModel||"equalpower")):e.panning={location:0,type:"stereo"},"stereo"!==e.panning.type||i.createStereoPanner||(console.log("Your browser does not support stereo panning. Falling back to 3D panning."),e.panning={location:[0,0,0],type:"3d",panningModel:"equalpower"})},c=function(e,t){t.delay?e.delay={delayTime:j(t.delay.delayTime,.5),maxDelayTime:j(t.delay.maxDelayTime,2),feedback:j(t.delay.feedback,.25),wet:j(t.delay.wet,.25)}:e.delay=null},f=function(e,t){e.nodes=[],e.mediaStreamSource=null,e.gain=null,getUserMedia({audio:!0,video:!1}).then(function(n){e.mediaStreamSource=i.createMediaStreamSource(n),d.micConsent=!0,p(e,t)}).catch(function(e){console.log("Error setting up microphone input: ",e)})},p=function(e,t){e.nodes=[],e.gain=i.createGain(),e.gain.gain.value=j(t.volume,e.volume),e.nodes.push(e.mediaStreamSource),e.nodes.push(e.gain),(e.filter||t.filter)&&w(e,t),(e.reverb||t.reverb)&&x(e,t),h(e,t),_(e,t),(e.delay||t.delay)&&C(e,t),E(e,t),e.setUpExternalFxOnPlay(t,i)},d=function(e){if(this.source=e.source,this.destination=e.destination||i.destination,this.volume=j(e.volume,1),this.defaultVolume=this.volume,this.playable=1,this.pitch=d.pitches[e.pitch]||e.pitch||440,this.detune=e.detune||0,this.globalReverb=e.globalReverb||!1,this.gain=[],this.loop=e.loop||!1,this.tuna=e.tuna||null,s(this,e),o(this,e),a(this,e),u(this,e),l(this,e),this.constructExternalFx(e,i),h(this,e),c(this,e),"noise"===this.source)this.decodedBuffer=t;else if("mic"===this.source)f(this,e);else if("object"==typeof this.source){var n=i.createBuffer(2,this.source[0].length,i.sampleRate);n.getChannelData(0).set(this.source[0]),n.getChannelData(1).set(this.source[1]),this.decodedBuffer=n}else this.source in{sine:0,sawtooth:0,square:0,triangle:0}?e.callback&&e.callback(this):r(this,e.callback)};d.micConsent=!1,d.audioContext=i,void 0!=window.Tuna&&(d.tuna=new Tuna(d.audioContext));var v=function(e,t){e.filter.forEach(function(e,i){e.node.frequency.linearRampToValueAtTime(e.frequency,t.exactTime),e.node.frequency.linearRampToValueAtTime(e.env.frequency,t.exactTime+e.env.attack)})},y=function(e,t){e.gain[0].gain.linearRampToValueAtTime(1e-4,t.exactTime),e.gain[0].gain.linearRampToValueAtTime(e.volume,t.exactTime+e.env.attack+1e-5),e.gain[0].gain.linearRampToValueAtTime(e.volume*e.env.sustain,t.exactTime+e.env.attack+e.env.decay+2e-5),e.gain[0].gain.linearRampToValueAtTime(e.volume*e.env.sustain,t.exactTime+e.env.attack+e.env.decay+e.env.hold+3e-5),e.gain[0].gain.linearRampToValueAtTime(1e-4,t.exactTime+e.env.attack+e.env.decay+e.env.hold+e.env.release+4e-5),e.soundSource.start(t.exactTime),e.soundSource.stop(t.exactTime+e.env.attack+e.env.decay+e.env.hold+e.env.release)},m=function(e,t){for(var i=t&&t.destination||e.destination,n=1;n<e.nodes.length;n++){if("custom"===e.nodes[n-1].interface)var s=e.nodes[n-1].output;else var s=e.nodes[n-1];if("custom"===e.nodes[n].interface)var o=e.nodes[n].input;else var o=e.nodes[n];s.connect(o)}if("custom"===e.nodes[e.nodes.length-1].interface)var r=e.nodes[e.nodes.length-1].output;else var r=e.nodes[e.nodes.length-1];r.connect(i),d.reverb&&e.globalReverb&&(e.nodes[e.nodes.length-1].connect(d.reverb.node),d.reverb.node.connect(d.reverb.gain),d.reverb.gain.connect(i))},g=function(e,t){t=t||{},e.soundSource=i.createOscillator(),e.soundSource.type=e.source,t.pitch?t.pitch in d.pitches?e.soundSource.frequency.value=d.pitches[t.pitch]:e.soundSource.frequency.value=t.pitch:e.soundSource.frequency.value=e.pitch,e.soundSource.detune.value=t.detune||e.detune},b=function(e,t){t&&t.env?(e.env.attack=j(t.env.attack,e.defaultEnv.attack),e.env.decay=j(t.env.decay,e.defaultEnv.decay),e.env.sustain=j(t.env.sustain,e.defaultEnv.sustain),e.env.hold=j(t.env.hold,e.defaultEnv.hold),e.env.release=j(t.env.release,e.defaultEnv.release)):e.env={attack:e.defaultEnv.attack,decay:e.defaultEnv.decay,sustain:e.defaultEnv.sustain,hold:e.defaultEnv.hold,release:e.defaultEnv.release}},w=function(e,t){t.filter&&!n(t.filter)&&(t.filter=[t.filter]),e.filter.forEach(function(n,s){n.node=i.createBiquadFilter(),n.node.type=n.type,n.node.frequency.value=t.filter&&t.filter[s]?t.filter[s].frequency||n.frequency:n.frequency,n.node.Q.value=t.filter&&t.filter[s]?t.filter[s].q||n.q:n.q,(t.filter&&t.filter[s].env||e.filter[s].env)&&"mic"!==e.source&&(n.env={attack:t.filter&&t.filter[s].env&&t.filter[s].env.attack||e.filter[s].env.attack,frequency:t.filter&&t.filter[s].env&&t.filter[s].env.frequency||e.filter[s].env.frequency}),e.nodes.push(n.node)})},k=function(e,t){t&&t.filter&&e.filter?(n(t.filter)||(t.filter=[t.filter]),w(e,t)):e.filter&&w(e,e)},x=function(e,t){var n={interface:"custom",input:i.createGain(),convolver:i.createConvolver(),wet:i.createGain(),output:i.createGain()};n.convolver.buffer=e.reverb.buffer,n.wet.gain.value=e.reverb.wet,n.input.connect(n.convolver),n.input.connect(n.output),n.convolver.connect(n.wet),n.wet.connect(n.output),e.reverb.node=n,e.nodes.push(e.reverb.node)},_=function(e,t){var n=t&&t.panning;void 0===n&&(n=e.panning.location),"number"==typeof n?(e.panning.node=i.createStereoPanner(),e.panning.node.pan.value=n,e.panning.type="stereo"):(e.panning.node=i.createPanner(),e.panning.node.setPosition(n[0],n[1],n[2]),e.panning.node.panningModel=t.panningModel||e.panningModel||"equalpower",e.panning.type="3d"),e.nodes.push(e.panning.node)},O=function(e,t){e.vibrato.wad=new d({source:e.vibrato.shape,pitch:e.vibrato.speed,volume:e.vibrato.magnitude,env:{attack:e.vibrato.attack},destination:e.soundSource.frequency}),e.vibrato.wad.play()},T=function(e,t){e.tremolo.wad=new d({source:e.tremolo.shape,pitch:e.tremolo.speed,volume:e.tremolo.magnitude,env:{attack:e.tremolo.attack,hold:10},destination:e.gain[0].gain}),e.tremolo.wad.play()},C=function(e,t){if(e.delay){t.delay||(t.delay={});var n={interface:"custom",input:i.createGain(),output:i.createGain(),delayNode:i.createDelay(e.delay.maxDelayTime),feedbackNode:i.createGain(),wetNode:i.createGain()};n.delayNode.delayTime.value=j(t.delay.delayTime,e.delay.delayTime),n.feedbackNode.gain.value=j(t.delay.feedback,e.delay.feedback),n.wetNode.gain.value=j(t.delay.wet,e.delay.wet),n.input.connect(n.delayNode),n.input.connect(n.output),n.delayNode.connect(n.feedbackNode),n.delayNode.connect(n.wetNode),n.feedbackNode.connect(n.delayNode),n.wetNode.connect(n.output),e.delay.delayNode=n,e.nodes.push(n)}},S=function(e,t){e.compressor=i.createDynamicsCompressor(),e.compressor.attack.value=j(t.compressor.attack,e.compressor.attack.value),e.compressor.knee.value=j(t.compressor.knee,e.compressor.knee.value),e.compressor.ratio.value=j(t.compressor.ratio,e.compressor.ratio.value),e.compressor.release.value=j(t.compressor.release,e.compressor.release.value),e.compressor.threshold.value=j(t.compressor.threshold,e.compressor.threshold.value),e.nodes.push(e.compressor)},E=function(e,t){if(e.tuna||t.tuna){var i={};if(e.tuna)for(var n in e.tuna)i[n]=e.tuna[n];if(t.tuna)for(var n in t.tuna)i[n]=t.tuna[n];console.log("tunaconfig: ",i);for(var n in i){console.log(n);var s=new d.tuna[n](i[n]);e.nodes.push(s)}}};d.prototype.constructExternalFx=function(e,t){},d.prototype.setUpExternalFxOnPlay=function(e,t){},d.prototype.play=function(e){return e=e||{arg:null},this.playable<1?(this.playOnLoad=!0,this.playOnLoadArg=e):"mic"===this.source?d.micConsent?null===e.arg?m(this,e):(o(this,e),a(this,e),u(this,e),l(this,e),this.constructExternalFx(e,i),h(this,e),c(this,e),p(this,e),m(this,e)):console.log("You have not given your browser permission to use your microphone."):(this.nodes=[],e.wait||(e.wait=0),e.volume?this.volume=e.volume:this.volume=this.defaultVolume,this.source in{sine:0,sawtooth:0,square:0,triangle:0}?g(this,e):(this.soundSource=i.createBufferSource(),this.soundSource.buffer=this.decodedBuffer,("noise"===this.source||this.loop||e.loop)&&(this.soundSource.loop=!0)),void 0===e.exactTime&&(e.exactTime=i.currentTime+e.wait),this.nodes.push(this.soundSource),b(this,e),k(this,e),E(this,e),this.setUpExternalFxOnPlay(e,i),this.gain.unshift(i.createGain()),this.gain[0].label=e.label,this.nodes.push(this.gain[0]),this.gain.length>15&&(this.gain.length=15),this.reverb&&x(this,e),_(this,e),C(this,e),m(this,e),this.filter&&this.filter[0].env&&v(this,e),y(this,e),this.vibrato&&O(this),this.tremolo&&T(this)),e.callback&&e.callback(this),this},d.prototype.setVolume=function(e){return this.defaultVolume=e,this.gain.length>0&&(this.gain[0].gain.value=e),this},d.prototype.setSpeed=function(e){var t;return t=e&&e>0?e:0,this.soundSource?this.soundSource.playbackRate.value=t:console.log("Sorry, but the wad does not contain a soundSource!"),this},d.prototype.setDetune=function(e){return this.soundSource.detune.value=e,this},d.prototype.setPanning=function(e){return this.panning.location=e,n(e)&&"3d"===this.panning.type&&this.panning.node?this.panning.node.setPosition(e[0],e[1],e[2]):"number"==typeof e&&"stereo"===this.panning.type&&this.panning.node&&(this.panning.node.pan.value=e),n(e)?this.panning.type="3d":"number"==typeof e&&(this.panning.type="stereo"),this},d.prototype.setReverb=function(e){var t;return t=e&&e>0&&e<1?e:e>=1?1:0,this.reverb?(this.reverb.wet=t,this.reverb.node&&(this.reverb.node.wet.gain.value=t)):console.log("Sorry, but the wad does not contain Reverb!"),this},d.prototype.setDelay=function(e,t,i){var n;n=e&&e>0?e:0;var s;s=t&&t>0&&t<1?t:t>=1?1:0;var o;return o=i&&i>0&&i<1?i:i>=1?1:0,this.delay?(this.delay.delayTime=n,this.delay.wet=s,this.delay.feedback=o,this.delay.delayNode&&(this.delay.delayNode.delayNode.delayTime.value=n,this.delay.delayNode.wetNode.gain.value=s,this.delay.delayNode.feedbackNode.gain.value=o)):console.log("Sorry, but the wad does not contain delay!"),this},d.prototype.stop=function(e){if("mic"!==this.source){if(e)for(var t=0;t<this.gain.length;t++)this.gain[t].label===e&&(this.gain[t].gain.cancelScheduledValues(i.currentTime),this.gain[t].gain.setValueAtTime(this.gain[t].gain.value,i.currentTime),this.gain[t].gain.linearRampToValueAtTime(1e-4,i.currentTime+this.env.release));e||(this.gain[0].gain.cancelScheduledValues(i.currentTime),this.gain[0].gain.setValueAtTime(this.gain[0].gain.value,i.currentTime),this.gain[0].gain.linearRampToValueAtTime(1e-4,i.currentTime+this.env.release))}else d.micConsent?this.mediaStreamSource.disconnect(0):console.log("You have not given your browser permission to use your microphone.");this.tremolo&&this.tremolo.wad.stop()};var P=new Uint8Array(2048),M=function(e){var t=Math.log(e/440)/Math.log(2)*12;return Math.round(t)+69};d.Poly=function(e){e||(e={}),this.isSetUp=!1,this.playable=1,e.reverb?l(this,e):this.setUp(e)},d.Poly.prototype.setUp=function(e){if(this.wads=[],this.input=i.createAnalyser(),this.input.fftSize=2048,this.nodes=[this.input],this.destination=e.destination||i.destination,this.volume=e.volume||1,this.output=i.createGain(),this.output.gain.value=this.volume,this.tuna=e.tuna||null,"undefined"!=typeof Recorder&&e.recConfig){this.rec=new Recorder(this.output,e.recConfig),this.rec.recordings=[];var t=this,n=function(e){t.rec.createWadArg.source=e,t.rec.recordings.unshift(new d(t.rec.createWadArg))};this.rec.createWad=function(e){this.createWadArg=e||{env:{hold:9001}},this.getBuffer(n)}}this.globalReverb=e.globalReverb||!1,o(this,e),this.filter&&w(this,e),this.reverb&&x(this,e),this.constructExternalFx(e,i),h(this,e),_(this,e),e.compressor&&S(this,e),c(this,e),C(this,e),E(this,e),this.nodes.push(this.output),m(this,e),this.isSetUp=!0,e.callback&&e.callback(this)},d.Poly.prototype.updatePitch=function(t){this.input.getByteTimeDomainData(P);var n=e(P,i.sampleRate);if(-1!==n&&11025!==n&&12e3!==n){var s=n;this.pitch=Math.floor(s);var o=M(s);this.noteName=d.pitchesArray[o-12]}var r=this;r.rafID=window.requestAnimationFrame(function(){r.updatePitch()})},d.Poly.prototype.stopUpdatingPitch=function(){cancelAnimationFrame(this.rafID)},d.Poly.prototype.setVolume=function(e){return this.isSetUp?this.output.gain.value=e:console.log("This PolyWad is not set up yet."),this},d.Poly.prototype.play=function(e){if(this.isSetUp)if(this.playable<1)this.playOnLoad=!0,this.playOnLoadArg=e;else{e&&e.volume&&(this.output.gain.value=e.volume,e.volume=void 0);for(var t=0;t<this.wads.length;t++)this.wads[t].play(e)}else console.log("This PolyWad is not set up yet.");return this},d.Poly.prototype.stop=function(e){if(this.isSetUp)for(var t=0;t<this.wads.length;t++)this.wads[t].stop(e)},d.Poly.prototype.add=function(e){return this.isSetUp?(e.destination=this.input,this.wads.push(e),e instanceof d.Poly&&(e.output.disconnect(0),e.output.connect(this.input))):console.log("This PolyWad is not set up yet."),this},d.Poly.prototype.remove=function(e){if(this.isSetUp)for(var t=0;t<this.wads.length;t++)this.wads[t]===e&&(this.wads[t].destination=i.destination,this.wads.splice(t,1),e instanceof d.Poly&&(e.output.disconnect(0),e.output.connect(i.destination)));return this},d.Poly.prototype.constructExternalFx=function(e,t){},d.defaultImpulse="http://www.codecur.io/us/sendaudio/widehall.wav",d.setGlobalReverb=function(e){d.reverb={},d.reverb.node=i.createConvolver(),d.reverb.gain=i.createGain(),d.reverb.gain.gain.value=e.wet;var t=e.impulse||d.defaultImpulse,n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){i.decodeAudioData(n.response,function(e){d.reverb.node.buffer=e})},n.send()};var j=function(e,t){return null==e?t:e};d.pitches={A0:27.5,"A#0":29.1352,Bb0:29.1352,B0:30.8677,"B#0":32.7032,Cb1:30.8677,C1:32.7032,"C#1":34.6478,Db1:34.6478,D1:36.7081,"D#1":38.8909,Eb1:38.8909,E1:41.2034,Fb1:41.2034,"E#1":43.6535,F1:43.6535,"F#1":46.2493,Gb1:46.2493,G1:48.9994,"G#1":51.9131,Ab1:51.9131,A1:55,"A#1":58.2705,Bb1:58.2705,B1:61.7354,Cb2:61.7354,"B#1":65.4064,C2:65.4064,"C#2":69.2957,Db2:69.2957,D2:73.4162,"D#2":77.7817,Eb2:77.7817,E2:82.4069,Fb2:82.4069,"E#2":87.3071,F2:87.3071,"F#2":92.4986,Gb2:92.4986,G2:97.9989,"G#2":103.826,Ab2:103.826,A2:110,"A#2":116.541,Bb2:116.541,B2:123.471,Cb3:123.471,"B#2":130.813,C3:130.813,"C#3":138.591,Db3:138.591,D3:146.832,"D#3":155.563,Eb3:155.563,E3:164.814,Fb3:164.814,"E#3":174.614,F3:174.614,"F#3":184.997,Gb3:184.997,G3:195.998,"G#3":207.652,Ab3:207.652,A3:220,"A#3":233.082,Bb3:233.082,B3:246.942,Cb4:246.942,"B#3":261.626,C4:261.626,"C#4":277.183,Db4:277.183,D4:293.665,"D#4":311.127,Eb4:311.127,E4:329.628,Fb4:329.628,"E#4":349.228,F4:349.228,"F#4":369.994,Gb4:369.994,G4:391.995,"G#4":415.305,Ab4:415.305,A4:440,"A#4":466.164,Bb4:466.164,B4:493.883,Cb5:493.883,"B#4":523.251,C5:523.251,"C#5":554.365,Db5:554.365,D5:587.33,"D#5":622.254,Eb5:622.254,E5:659.255,Fb5:659.255,"E#5":698.456,F5:698.456,"F#5":739.989,Gb5:739.989,G5:783.991,"G#5":830.609,Ab5:830.609,A5:880,"A#5":932.328,Bb5:932.328,B5:987.767,Cb6:987.767,"B#5":1046.5,C6:1046.5,"C#6":1108.73,Db6:1108.73,D6:1174.66,"D#6":1244.51,Eb6:1244.51,Fb6:1318.51,E6:1318.51,"E#6":1396.91,F6:1396.91,"F#6":1479.98,Gb6:1479.98,G6:1567.98,"G#6":1661.22,Ab6:1661.22,A6:1760,"A#6":1864.66,Bb6:1864.66,B6:1975.53,Cb7:1975.53,"B#6":2093,C7:2093,"C#7":2217.46,Db7:2217.46,D7:2349.32,"D#7":2489.02,Eb7:2489.02,E7:2637.02,Fb7:2637.02,"E#7":2793.83,F7:2793.83,"F#7":2959.96,Gb7:2959.96,G7:3135.96,"G#7":3322.44,Ab7:3322.44,A7:3520,"A#7":3729.31,Bb7:3729.31,B7:3951.07,Cb8:3951.07,"B#7":4186.01,C8:4186.01},d.pitchesArray=["C0","C#0","D0","D#0","E0","F0","F#0","G0","G#0","A0","A#0","B0","C1","C#1","D1","D#1","E1","F1","F#1","G1","G#1","A1","A#1","B1","C2","C#2","D2","D#2","E2","F2","F#2","G2","G#2","A2","A#2","B2","C3","C#3","D3","D#3","E3","F3","F#3","G3","G#3","A3","A#3","B3","C4","C#4","D4","D#4","E4","F4","F#4","G4","G#4","A4","A#4","B4","C5","C#5","D5","D#5","E5","F5","F#5","G5","G#5","A5","A#5","B5","C6","C#6","D6","D#6","E6","F6","F#6","G6","G#6","A6","A#6","B6","C7","C#7","D7","D#7","E7","F7","F#7","G7","G#7","A7","A#7","B7","C8"],d.midiInstrument={play:function(){console.log("playing midi")},stop:function(){console.log("stopping midi")}},d.midiInputs=[],midiMap=function(e){console.log(e.receivedTime,e.data),144===e.data[0]?0===e.data[2]?(console.log("|| stopping note: ",d.pitchesArray[e.data[1]-12]),d.midiInstrument.stop(d.pitchesArray[e.data[1]-12])):e.data[2]>0&&(console.log("> playing note: ",d.pitchesArray[e.data[1]-12]),d.midiInstrument.play({pitch:d.pitchesArray[e.data[1]-12],label:d.pitchesArray[e.data[1]-12],callback:function(e){}})):176===e.data[0]?(console.log("controller"),46==e.data[1]&&(127==e.data[2]?d.midiInstrument.pedalMod=!0:0==e.data[2]&&(d.midiInstrument.pedalMod=!1))):224===e.data[0]&&console.log("pitch bend")};var A=function(e){d.midiInputs=[];for(var t=e.inputs.values(),i=t.next();!i.done;i=t.next())d.midiInputs.push(i.value);console.log("MIDI inputs: ",d.midiInputs);for(var n=0;n<d.midiInputs.length;n++)d.midiInputs[n].onmidimessage=midiMap},F=function(e){console.log("uh-oh! Something went wrong!  Error code: "+e.code)};if(navigator&&navigator.requestMIDIAccess)try{navigator.requestMIDIAccess().then(A,F)}catch(e){var R="There was an error on this page.\n\n";R+="Error description: "+e.message+"\n\n",R+="Click OK to continue.\n\n",console.log(R)}return d.presets={hiHatClosed:{source:"noise",env:{attack:.001,decay:.008,sustain:.2,hold:.03,release:.01},filter:{type:"highpass",frequency:400,q:1}},snare:{source:"noise",env:{attack:.001,decay:.01,sustain:.2,hold:.03,release:.02},filter:{type:"bandpass",frequency:300,q:.18}},hiHatOpen:{source:"noise",env:{attack:.001,decay:.008,sustain:.2,hold:.43,release:.01},filter:{type:"highpass",frequency:100,q:.2}},ghost:{source:"square",volume:.3,env:{attack:.01,decay:.002,sustain:.5,hold:2.5,release:.3},filter:{type:"lowpass",frequency:600,q:7,env:{attack:.7,frequency:1600}},vibrato:{attack:8,speed:8,magnitude:100}},piano:{source:"square",volume:1.4,env:{attack:.01,decay:.005,sustain:.2,hold:.015,release:.3},filter:{type:"lowpass",frequency:1200,q:8.5,env:{attack:.2,frequency:600}}}},d}();return void 0!==e&&e.exports&&(e.exports=n),n})},function(e,t){var i;i=function(){return this}();try{i=i||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t){},function(e,t,i){e.exports=i(23)}])});